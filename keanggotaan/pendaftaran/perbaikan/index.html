<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perbaikan Data Pendaftaran - HC 32</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="../../config.js"></script>
  <script src="../../components.js"></script>

  <style>
    :root {
      --hc-blue: #1a4787; --hc-toska: #0f8a94; --hc-bg: #e7e9ea;
      --hc-red: #d30e14; --card: #ffffff; --radius: 18px;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--hc-bg); color: #0f172a; margin: 0; }
    .main-wrapper { padding: 40px 15px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { max-width: 550px; width: 100%; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: 0 10px 35px rgba(2, 6, 23, .08); padding: 30px; border: 1px solid #e2e8f0; }
    .header { text-align: center; margin-bottom: 25px; }
    .header h2 { margin: 0; color: var(--hc-blue); font-weight: 800; }
    .header p { font-size: 13px; color: #64748b; margin-top: 5px; }
    
    .instruction-box { background: #fff1f2; border-left: 4px solid var(--hc-red); padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; }
    
    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #1e293b; }
    input, select, textarea { 
      width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 12px; 
      font-family: inherit; font-size: 14px; outline: none; transition: 0.2s;
    }
    input:focus { border-color: var(--hc-blue); box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.1); }
    
    .btn-submit { 
      width: 100%; padding: 15px; background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska)); 
      color: #fff; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px;
    }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }
    
    #form-perbaikan { display: none; }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="container">
      <div class="card">
        <div class="header">
          <h2>Perbaikan Data</h2>
          <p id="txt-code">Memuat data permintaan...</p>
        </div>

        <div id="instruction" class="instruction-box" style="display:none;">
          <strong>Alasan Penolakan:</strong><br>
          <span id="txt-reason">...</span>
        </div>

        <form id="form-perbaikan">
          <div id="dynamic-fields"></div>
          
          <div class="form-group">
            <label>Pesan Tambahan untuk Pengurus (Opsional)</label>
            <textarea id="user-note" placeholder="Jelaskan perbaikan yang Anda lakukan..."></textarea>
          </div>

          <button type="submit" class="btn-submit" id="btn-send">
            <i class="ri-send-plane-fill"></i> Kirim Perbaikan Data
          </button>
        </form>

        <div id="loading-init" style="text-align:center; padding: 20px;">
            <i class="ri-loader-4-line ri-spin" style="font-size: 30px; color: var(--hc-blue);"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    let TRACKING_CODE = "";
    let DETAILED_DATA = null;

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      TRACKING_CODE = params.get('code');
      if (!TRACKING_CODE) {
          alert("Kode tracking tidak ditemukan!");
          window.location.href = "../../../bantuan/track/";
          return;
      }
      document.getElementById('txt-code').innerText = "Kode: " + TRACKING_CODE;
      loadDataRequest();
    });

    async function loadDataRequest() {
      try {
        const res = await hc32_post('trackRequest', { 
            trackingCode: TRACKING_CODE, 
            secret: "ADMIN_BYPASS", 
            verifier: "ADMIN_BYPASS" 
        });
        
        if (res.status === 'ok') {
          DETAILED_DATA = res.request.detailedData;
          
          if (!DETAILED_DATA) {
              document.getElementById('loading-init').innerHTML = "<p style='color:red'>Gagal memuat rincian data. Hubungi Pengurus.</p>";
              return;
          }
          
          document.getElementById('txt-reason').innerText = res.request.publicNote;
          document.getElementById('instruction').style.display = 'block';
          generateFields(res.request.publicNote);
          document.getElementById('loading-init').style.display = 'none';
          document.getElementById('form-perbaikan').style.display = 'block';
        } else {
          document.getElementById('loading-init').innerHTML = `<p style='color:red'>Error: ${res.message}</p>`;
        }
      } catch (e) {
        document.getElementById('loading-init').innerHTML = "<p style='color:red'>Gagal terhubung ke server.</p>";
      }
    }

    function generateFields(note) {
      const container = document.getElementById('dynamic-fields');
      const fieldsMap = [
        { key: "nama", label: "Nama Lengkap", type: "text" },
        { key: "nis", label: "Nomor Identitas (NIS/NIP)", type: "text" },
        { key: "kelas", label: "Data Kelas", type: "text" },
        { key: "email", label: "Alamat Email", type: "email" },
        { key: "nohp", label: "Nomor WhatsApp", type: "text" }
      ];

      fieldsMap.forEach(field => {
        if (note.includes(field.label)) {
          const div = document.createElement('div');
          div.className = 'form-group';
          div.innerHTML = `
            <label>${field.label}</label>
            <input type="${field.type}" id="inp-${field.key}" value="${DETAILED_DATA[field.key] || ''}" required>
          `;
          container.appendChild(div);
        }
      });

      if (container.innerHTML === "") {
          container.innerHTML = "<p style='font-size:12px; color:var(--hc-red)'>Silakan hubungi pengurus untuk instruksi lebih lanjut.</p>";
      }
    }

    // HANDLER SUBMIT REVISI (AMAN DARI CSP)
    document.getElementById('form-perbaikan').onsubmit = async (e) => {
      e.preventDefault();
      const btnSend = document.getElementById('btn-send');
      btnSend.disabled = true;
      
      if(window.showHC32Spinner) window.showHC32Spinner("Mengirim perbaikan...");

      const updatedData = {};
      const inputs = document.querySelectorAll('#dynamic-fields input');
      inputs.forEach(inp => {
          const key = inp.id.replace('inp-', '');
          updatedData[key] = inp.value;
      });

      const userNote = document.getElementById('user-note').value;

      try {
        const res = await hc32_post('submitPerbaikanMandiri', {
            trackingCode: TRACKING_CODE,
            updatedData: updatedData,
            note: userNote
        });

        if (res.status === 'ok') {
          if(window.hideHC32Spinner) window.hideHC32Spinner();
          
          if(window.showHC32Status) {
            window.showHC32Status('success', 'Berhasil', 'Data perbaikan telah dikirim ke pengurus.');
          }

          // REDIRECT AMAN - Menggunakan function anonim & path absolut relatif yang benar
          setTimeout(function() {
              window.location.href = "../../../bantuan/track/?code=" + encodeURIComponent(TRACKING_CODE);
          }, 2000);
          
        } else {
          throw new Error(res.message);
        }
      } catch (err) {
        if(window.hideHC32Spinner) window.hideHC32Spinner();
        if(window.showHC32Status) {
            window.showHC32Status('error', 'Gagal Mengirim', err.message);
        } else {
            alert("Gagal mengirim: " + err.message);
        }
        btnSend.disabled = false;
      }
    };
  </script>
</body>
</html>
