<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Pengurus - HC 32</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="../../config.js"></script>
  <script src="../../components.js"></script>

  <style>
    /* Variabel Warna dari Brand Guide */
    :root {
        --hc-blue: #1a4787;
        --hc-toska: #0f8a94;
        --hc-dark: #2e2e2e;
        --hc-bg: #e7e9ea;
        --card-shadow: 0 8px 30px rgba(26, 71, 135, 0.08); /* Shadow konsisten dengan pendaftaran */
    }

    body {
        font-family: 'Poppins', system-ui, -apple-system, sans-serif;
        background-color: var(--hc-bg);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    /* Container Utama Login */
    .login-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px; /* Padding disamakan dengan pendaftaran */
        gap: 20px;
    }

    /* KONSISTENSI UKURAN CARD (Sesuai Pendaftaran: max-width 600px) */
    .login-card, .help-card {
        width: 100%;
        max-width: 600px; /* Disamakan dengan form pendaftaran */
        box-sizing: border-box;
    }

    /* Kartu Login */
    .login-card {
        background: white;
        border-radius: 16px; /* Radius disamakan */
        box-shadow: var(--card-shadow);
        border: 1px solid #cbd5e1; /* Border disamakan */
        padding: 30px; /* Padding disamakan */
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    /* Hiasan Atas */
    .login-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
        background: linear-gradient(to right, var(--hc-blue), var(--hc-toska));
    }

    /* Logo Header (UPDATED) */
    .login-header-logo {
        width: 100%; /* Full width container */
        max-width: 250px; /* Batas lebar logo agar tidak terlalu besar */
        height: auto;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* Hapus border bulat & background */
        background: transparent;
        box-shadow: none;
        border: none;
    }
    .login-header-logo img {
        width: 100%;
        height: auto;
        object-fit: contain; /* Pastikan logo utuh */
    }

    .login-title {
        font-size: 24px; /* Disamakan dengan h2 pendaftaran */
        font-weight: 700;
        color: var(--hc-dark);
        margin-bottom: 8px;
    }
    .login-subtitle {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 30px;
        font-weight: 300;
    }

    /* Form Group */
    .form-group {
        text-align: left;
        margin-bottom: 20px;
    }
    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--hc-dark);
        margin-bottom: 8px;
    }
    .input-wrapper {
        position: relative;
    }
    .input-icon {
        position: absolute;
        left: 16px; /* Sesuaikan padding */
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 18px;
    }
    
    /* Tombol Lihat Password */
    .toggle-password {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 18px;
        cursor: pointer;
        padding: 5px;
    }
    .toggle-password:hover {
        color: var(--hc-blue);
    }

    .form-input {
        width: 100%;
        padding: 12px 40px 12px 44px; /* Padding kiri/kanan disesuaikan icon */
        border: 1px solid #cbd5e1;
        border-radius: 10px; /* Radius input disamakan */
        font-size: 15px;
        outline: none;
        transition: all 0.2s;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }
    .form-input:focus {
        border-color: var(--hc-blue);
        box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.15);
    }

    /* Tombol Login */
    .btn-login {
        width: 100%;
        padding: 16px; /* Padding tombol disamakan */
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska));
        color: white;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 10px;
        font-family: 'Poppins', sans-serif;
        box-shadow: 0 4px 15px rgba(15, 138, 148, 0.3);
    }
    .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(15, 138, 148, 0.4);
    }
    .btn-login:active {
        transform: scale(0.98);
    }

    /* Info Tambahan */
    .info-box {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
        font-size: 12px;
        color: #94a3b8;
        font-style: italic;
    }

    /* HELP CARD (Persis Pendaftaran) */
    .help-card {
        background: #fff; 
        border-radius: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        padding: 16px 20px;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: space-between; 
        gap: 12px;
        border-left: 4px solid var(--hc-blue);
    }
    @media (min-width: 600px) { .help-card { flex-direction: row; } }
    
    .help-title { font-weight: 600; font-size: 14px; color: var(--hc-dark); margin: 0; }
    .help-desc { font-size: 12px; color: #64748b; margin: 2px 0 0; }
    .help-link { color: var(--hc-blue); font-weight: 600; text-decoration: none; }
    .help-btn { 
        display: inline-flex; 
        align-items: center; 
        gap: 8px; 
        background: var(--hc-blue); 
        color: white; 
        padding: 8px 16px; 
        border-radius: 8px; 
        font-size: 13px; 
        font-weight: 500; 
        text-decoration: none; 
        transition: 0.2s; 
    }
    .help-btn:hover { opacity: 0.9; }

    /* Modal OTP */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        display: none; align-items: center; justify-content: center; z-index: 2000;
        backdrop-filter: blur(3px);
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
        background: white; width: 90%; max-width: 400px; padding: 25px;
        border-radius: 16px; position: relative; text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;} }
    
    .otp-inputs { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
    .otp-input {
        width: 45px; height: 50px; border: 1px solid #cbd5e1; border-radius: 8px;
        font-size: 24px; text-align: center; font-weight: bold; color: var(--hc-blue);
    }
    .otp-input:focus { border-color: var(--hc-toska); outline: none; box-shadow: 0 0 0 3px rgba(15,138,148,0.1); }

    .link-lupa {
        font-size: 12px; color: var(--hc-blue); text-decoration: none; 
        font-weight: 600; float: right; margin-top: 5px; cursor: pointer;
    }
    .link-lupa:hover { text-decoration: underline; }
    
  </style>
</head>
<body>

  <div class="login-wrapper">
      
      <div class="login-card">
          <div class="login-header-logo">
              <img src="https://drive.google.com/thumbnail?id=1kb_yesHbnVPtCrjzlWZGD_XXtfQoaLEe&sz=w600" alt="History Club 32">
          </div>
          
          <h2 class="login-title">Login Pengurus</h2>
          <p class="login-subtitle">Masuk untuk mengakses Dashboard HC 32</p>

          <form id="login-form" onsubmit="event.preventDefault();">
              <div class="form-group">
                  <label class="form-label">ID HC / Username</label>
                  <div class="input-wrapper">
                      <i class="ri-user-line input-icon"></i>
                      <input id="login-username" type="text" class="form-input" placeholder="Masukkan ID Pengurus" required autocomplete="username">
                  </div>
              </div>

              <div class="form-group">
                  <label class="form-label">Kata Sandi</label>
                  <div class="input-wrapper">
                      <i class="ri-lock-line input-icon"></i>
                      <input id="login-password" type="password" class="form-input" placeholder="Masukkan Kata Sandi" required autocomplete="current-password">
                      <i class="ri-eye-off-line toggle-password" id="toggle-password" title="Lihat Password"></i>
                  </div>
              </div>

              <button type="submit" id="login-btn" class="btn-login">Masuk Sekarang</button>
          </form>

          <div class="form-group">
              <i class="ri-eye-off-line toggle-password" id="toggle-password" title="Lihat Password"></i>
          </div>
          <div style="margin-top: -15px; margin-bottom: 20px; text-align: right;">
              <a href="#" class="link-lupa" onclick="openOtpModal()">Lupa Kata Sandi? / Login OTP</a>
          </div>
      </div>

      <div class="help-card">
          <div style="flex:1;">
              <p class="help-title">Butuh Bantuan?</p>
              <p class="help-desc">Hubungi Ketua HC <a href="https://instagram.com/mickovoitto" target="_blank" class="help-link">@mickovoitto</a> jika mengalami kendala sistem.</p>
          </div>
          <a href="https://www.instagram.com/historyclub32jkt/" target="_blank" class="help-btn">
              Instagram HC 32
              <i class="ri-instagram-line"></i>
          </a>
      </div>

  </div>

  <script>
    // Inisialisasi Navigasi
    document.addEventListener('DOMContentLoaded', () => initHC32Navigation('login'));

    // Gunakan URL dari config.js
    const API_URL = (typeof GAS_URL !== 'undefined') ? GAS_URL : "https://script.google.com/macros/s/AKfycbz22NwYQ-WJwmdieMgzQxw1I2lXKTghebFO-oSY-wE_av-3oEYIi9TfSCqJCpy3iZKt/exec";
    const DASHBOARD_BASE = "https://historyclub32.github.io/pengurus/dashboard.html";

    // --- FITUR LIHAT PASSWORD ---
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('login-password');

    togglePassword.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('ri-eye-line');
        this.classList.toggle('ri-eye-off-line');
    });

    // --- LOGIKA LOGIN UPDATE (Support 2FA) ---
    document.getElementById("login-form").addEventListener("submit", async () => {
        const u = document.getElementById("login-username").value.trim();
        const p = document.getElementById("login-password").value.trim();

        if (!u || !p) {
            window.showHC32Status('error', 'Data Belum Lengkap', 'Mohon isi ID dan Password.');
            return;
        }

        // Loader Global
        window.showHC32Status('loading', 'Memeriksa Akun...', 'Mohon tunggu sebentar.');

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "loginAdmin",
                    username: u,
                    password: p
                })
            });
            
            const out = await res.json();

            // Skenario 1: Login Langsung (Status OK) - Jarang terjadi jika email ada
            if (out.status === "ok") {
                handleLoginSuccess(out);
            
            // Skenario 2: Butuh OTP (Status otp_required) - INI YANG BARU
            } else if (out.status === "otp_required") {
                
                // 1. Sembunyikan Loader
                window.hideHC32Status();
                
                // 2. Set Data OTP
                currentOtpUser = out.username; // Simpan username untuk verifikasi nanti
                document.getElementById('otp-email-display').innerText = out.email;
                
                // 3. Buka Modal Verifikasi OTP (Langsung)
                document.getElementById('modal-otp-request').classList.remove('active'); // Pastikan request tutup
                document.getElementById('modal-otp-verify').classList.add('active');
                
                // 4. Fokus ke input pertama
                setTimeout(() => {
                    const firstInput = document.querySelector('.otp-input');
                    if(firstInput) firstInput.focus();
                }, 300);

            } else {
                // Skenario 3: Gagal (Password salah / User tidak ada)
                window.showHC32Status('error', 'Login Gagal', out.message || 'ID atau Password salah.');
            }

        } catch (err) {
            console.error(err);
            window.showHC32Status('error', 'Kesalahan Koneksi', 'Gagal menghubungi server. Periksa internet Anda.');
        }
    });

    // Helper: Redirect ke Dashboard
    function handleLoginSuccess(out) {
        window.showHC32Status('success', 'Login Berhasil!', 'Mengarahkan ke Dashboard...');
        
        const url = new URL(DASHBOARD_BASE);
        url.searchParams.set("token", out.token);
        url.searchParams.set("u", out.username);
        url.searchParams.set("n", out.nama);
        url.searchParams.set("r", out.role);
        url.searchParams.set("t", out.tipe || "");
        url.searchParams.set("j", out.jabatan || "Admin");
        url.searchParams.set("f", out.foto || "");

        setTimeout(() => {
            window.open(url.toString(), "_blank");
            window.location.reload(); 
        }, 1500);
    }

    // --- OTP SYSTEM ---
    let currentOtpUser = '';

    function openOtpModal() {
        document.getElementById('modal-otp-request').classList.add('active');
        document.getElementById('modal-otp-verify').classList.remove('active');
        // Prefill jika user sudah mengetik di form login utama
        const mainUser = document.getElementById('login-username').value;
        if(mainUser) document.getElementById('otp-username-req').value = mainUser;
    }

    function closeOtpModal() {
        document.getElementById('modal-otp-request').classList.remove('active');
        document.getElementById('modal-otp-verify').classList.remove('active');
    }

    // Input digit otomatis pindah
    function digitInput(el, idx) {
        el.value = el.value.replace(/[^0-9]/g, '');
        if(el.value.length >= 1) {
            const next = el.nextElementSibling;
            if(next) next.focus();
        }
    }

    async function requestOtp() {
        const user = document.getElementById('otp-username-req').value.trim();
        if(!user) return alert("Masukkan ID Pengurus");

        const btn = document.getElementById('btn-req-otp');
        btn.innerText = "Mengirim...";
        btn.disabled = true;

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "requestOtpAdmin", username: user })
            });
            const out = await res.json();
            
            if(out.status === 'ok') {
                currentOtpUser = user;
                document.getElementById('otp-email-display').innerText = out.email;
                document.getElementById('modal-otp-request').classList.remove('active');
                document.getElementById('modal-otp-verify').classList.add('active');
                // Clear inputs
                document.querySelectorAll('.otp-input').forEach(i => i.value = '');
                document.querySelector('.otp-input').focus();
            } else {
                alert(out.message);
            }
        } catch(e) {
            alert("Gagal koneksi: " + e.message);
        }
        btn.innerText = "Kirim Kode OTP";
        btn.disabled = false;
    }

    async function verifyOtp() {
        // Gabungkan 6 digit
        let code = '';
        document.querySelectorAll('.otp-input').forEach(i => code += i.value);
        
        if(code.length < 6) return alert("Masukkan 6 digit kode");

        window.showHC32Status('loading', 'Verifikasi...', 'Memeriksa kode OTP.');

        try {
             const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "verifyOtpAdmin", 
                    username: currentOtpUser,
                    otp: code
                })
            });
            const out = await res.json();

            if (out.status === "ok") {
                window.showHC32Status('success', 'Verifikasi Berhasil!', 'Mengarahkan ke Dashboard...');
                
                // Gunakan DASHBOARD_BASE yang sudah ada
                const url = new URL(DASHBOARD_BASE);
                url.searchParams.set("token", out.token);
                url.searchParams.set("u", out.username);
                url.searchParams.set("n", out.nama);
                url.searchParams.set("r", out.role);
                url.searchParams.set("t", out.tipe || "");
                url.searchParams.set("j", out.jabatan || "Admin");
                url.searchParams.set("f", out.foto || "");

                setTimeout(() => {
                    window.open(url.toString(), "_blank");
                    window.location.reload(); 
                }, 1500);
            } else {
                window.showHC32Status('error', 'Gagal', out.message);
            }
        } catch(e) {
             window.showHC32Status('error', 'Error', e.message);
        }
    }
  </script

  <div class="modal-overlay" id="modal-otp-request">
      <div class="modal-card">
          <button onclick="closeOtpModal()" style="position:absolute; top:15px; right:15px; border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
          <h3 style="margin-top:0; color:var(--hc-blue);">Login dengan OTP</h3>
          <p style="font-size:13px; color:#64748b; margin-bottom:20px;">Masukkan ID Pengurus Anda. Kami akan mengirimkan kode akses ke email yang terdaftar di sistem.</p>
        
          <input type="text" id="otp-username-req" class="form-input" placeholder="Masukkan ID Pengurus (NIS/Username)" style="text-align:center; margin-bottom:15px;">
        
          <button onclick="requestOtp()" class="btn-login" id="btn-req-otp">Kirim Kode OTP</button>
      </div>
   </div>

   <div class="modal-overlay" id="modal-otp-verify">
       <div class="modal-card">
           <h3 style="margin-top:0; color:var(--hc-blue);">Verifikasi Kode</h3>
           <p style="font-size:13px; color:#64748b;">Masukkan 6 digit kode yang dikirim ke <br><strong id="otp-email-display">email</strong></p>
        
           <div class="otp-inputs" id="otp-container">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,1)">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,2)">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,3)">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,4)">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,5)">
               <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,6)">
           </div>
        
           <button onclick="verifyOtp()" class="btn-login">Verifikasi & Masuk</button>
           <p style="font-size:12px; margin-top:15px; cursor:pointer; color:#64748b;" onclick="openOtpModal()">Kirim Ulang Kode?</p>
       </div>
   </div> 
</body>
</html>
