<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Pengurus - HC 32</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="../../config.js"></script>
  <script src="../../components.js"></script>

  <style>
    :root{
      --hc-blue:#1a4787;
      --hc-toska:#0f8a94;
      --hc-dark:#2e2e2e;
      --hc-bg:#e7e9ea;
      --hc-red:#d30e14;
      --card-shadow:0 8px 30px rgba(26,71,135,.08);
    }

    body{
      font-family:'Poppins',system-ui,-apple-system,sans-serif;
      background-color:var(--hc-bg);
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .login-wrapper{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:40px 20px;
      gap:20px;
    }

    .login-card,.help-card{
      width:100%;
      max-width:600px;
      box-sizing:border-box;
    }

    .login-card{
      background:#fff;
      border-radius:16px;
      box-shadow:var(--card-shadow);
      border:1px solid #cbd5e1;
      padding:30px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .login-card::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:6px;
      background:linear-gradient(to right,var(--hc-blue),var(--hc-toska));
    }

    .login-header-logo{
      width:100%;
      max-width:250px;
      height:auto;
      margin:0 auto 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      box-shadow:none;
      border:none;
    }
    .login-header-logo img{width:100%;height:auto;object-fit:contain;}

    .login-title{
      font-size:24px;
      font-weight:700;
      color:var(--hc-dark);
      margin-bottom:8px;
    }
    .login-subtitle{
      font-size:14px;
      color:#64748b;
      margin-bottom:26px;
      font-weight:300;
    }

    .form-group{ text-align:left; margin-bottom:18px; }
    .form-label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--hc-dark);
      margin-bottom:8px;
    }

    .input-wrapper{ position:relative; }
    .input-icon{
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      color:#94a3b8;
      font-size:18px;
      pointer-events:none;
    }

    .form-input{
      width:100%;
      padding:12px 50px 12px 44px; /* kanan buat tombol mata */
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-size:15px;
      outline:none;
      transition:all .2s;
      box-sizing:border-box;
      font-family:'Poppins',sans-serif;
      background:#fff;
    }
    .form-input:focus{
      border-color:var(--hc-blue);
      box-shadow:0 0 0 3px rgba(26,71,135,.15);
    }

    /* Tombol mata (lebih rapi) */
    .toggle-eye{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:38px;
      height:38px;
      border-radius:10px;
      border:1px solid #e2e8f0;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#94a3b8;
      transition:.18s;
      padding:0;
    }
    .toggle-eye:hover{
      color:var(--hc-blue);
      border-color:#cbd5e1;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }
    .toggle-eye:active{ transform:translateY(-50%) scale(.98); }
    .toggle-eye i{ font-size:18px; line-height:1; }

    /* ERROR STATE (mirip pendaftaran) */
    .input-error{
      border-color:var(--hc-red) !important;
      box-shadow:0 0 0 3px rgba(211,14,20,.12) !important;
      animation:shakeInput .3s;
    }
    @keyframes shakeInput{
      0%{transform:translateX(0)}
      25%{transform:translateX(-2px)}
      75%{transform:translateX(2px)}
    }

    .btn-login{
      width:100%;
      padding:16px;
      border:none;
      border-radius:10px;
      background:linear-gradient(135deg,var(--hc-blue),var(--hc-toska));
      color:#fff;
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      transition:transform .2s, box-shadow .2s;
      margin-top:10px;
      font-family:'Poppins',sans-serif;
      box-shadow:0 4px 15px rgba(15,138,148,.3);
    }
    .btn-login:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(15,138,148,.4);
    }
    .btn-login:active{ transform:scale(.98); }
    .btn-login:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .link-lupa{
      font-size:12px;
      color:var(--hc-blue);
      text-decoration:none;
      font-weight:600;
      float:right;
      margin-top:5px;
      cursor:pointer;
    }
    .link-lupa:hover{ text-decoration:underline; }

    .link-back{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      font-size:12px;
      color:#64748b;
      text-decoration:none;
      font-weight:600;
    }
    .link-back:hover{ color:var(--hc-blue); }

    /* HELP CARD */
    .help-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      padding:16px 20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-left:4px solid var(--hc-blue);
    }
    @media (min-width:600px){ .help-card{ flex-direction:row; } }
    .help-title{ font-weight:600; font-size:14px; color:var(--hc-dark); margin:0; }
    .help-desc{ font-size:12px; color:#64748b; margin:2px 0 0; }
    .help-link{ color:var(--hc-blue); font-weight:600; text-decoration:none; }
    .help-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--hc-blue);
      color:#fff;
      padding:8px 16px;
      border-radius:8px;
      font-size:13px;
      font-weight:500;
      text-decoration:none;
      transition:.2s;
    }
    .help-btn:hover{ opacity:.9; }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      backdrop-filter:blur(3px);
    }
    .modal-overlay.active{ display:flex; }
    .modal-card{
      background:#fff;
      width:90%;
      max-width:420px;
      padding:22px;
      border-radius:16px;
      position:relative;
      text-align:center;
      box-shadow:0 10px 40px rgba(0,0,0,.2);
      animation:slideUp .3s ease-out;
    }
    @keyframes slideUp{
      from{ transform:translateY(20px); opacity:0; }
      to{ transform:translateY(0); opacity:1; }
    }

    .otp-inputs{ display:flex; justify-content:center; gap:8px; margin:20px 0; }
    .otp-input{
      width:45px; height:50px;
      border:1px solid #cbd5e1;
      border-radius:8px;
      font-size:24px;
      text-align:center;
      font-weight:700;
      color:var(--hc-blue);
      font-family:'Poppins',sans-serif;
    }
    .otp-input:focus{
      border-color:var(--hc-toska);
      outline:none;
      box-shadow:0 0 0 3px rgba(15,138,148,.1);
    }

    /* UTIL */
    .hidden{ display:none !important; }

    /* Info token (status/email/username/countdown) rapi */
    .token-info{
      margin:10px 0 18px;
      padding:12px 14px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:12px;
      text-align:left;
      font-size:12px;
      color:#475569;
    }
    .token-grid{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .token-label{
      color:#334155;
      font-weight:700;
      white-space:nowrap;
    }
    .token-value{
      color:#0f172a;
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .token-value.muted{ color:#64748b; font-weight:500; }
    .token-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      border:1px solid #e2e8f0;
      background:#fff;
    }
    .pill-ok{ color:#0f766e; border-color:rgba(15,138,148,.25); background:rgba(15,138,148,.08); }
    .pill-bad{ color:#b91c1c; border-color:rgba(211,14,20,.25); background:rgba(211,14,20,.08); }

    .small-note{
      margin:10px 0 0;
      font-size:12px;
      color:#94a3b8;
      font-style:italic;
      text-align:left;
    }

    /* Hint aturan kata sandi */
    .pw-hint{
      margin-top:8px;
      font-size:12px;
      color:#64748b;
      line-height:1.5;
    }
    .pw-hint b{ color:var(--hc-dark); }

    /* tombol close di modal request */
    .modal-close{
      position:absolute;
      top:12px;
      right:12px;
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background:#fff;
      cursor:pointer;
      font-size:22px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.15s;
    }
    .modal-close:hover{ box-shadow:0 6px 16px rgba(0,0,0,.08); color:var(--hc-blue); }

    /* OTP countdown (tambahan) */
    #otp-countdown.expired{
      color: var(--hc-red);
    }
  </style>
</head>

<body>
  <div class="login-wrapper">

    <!-- CARD LOGIN -->
    <div class="login-card" id="card-login">
      <div class="login-header-logo">
        <img src="https://drive.google.com/thumbnail?id=1kb_yesHbnVPtCrjzlWZGD_XXtfQoaLEe&sz=w600" alt="History Club 32">
      </div>

      <h2 class="login-title">Login Pengurus</h2>
      <p class="login-subtitle">Masuk untuk mengakses Dashboard HC 32</p>

      <form id="login-form" onsubmit="event.preventDefault();">
        <div class="form-group">
          <label class="form-label">ID HC / Username</label>
          <div class="input-wrapper">
            <i class="ri-user-line input-icon"></i>
            <input id="login-username" type="text" class="form-input" placeholder="Masukkan ID Pengurus" required autocomplete="username">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Kata Sandi</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input id="login-password" type="password" class="form-input" placeholder="Masukkan Kata Sandi" required autocomplete="current-password">
            <button type="button" class="toggle-eye" id="toggle-password" title="Lihat Kata Sandi">
              <i class="ri-eye-off-line"></i>
            </button>
          </div>
        </div>

        <button type="submit" id="login-btn" class="btn-login">Masuk Sekarang</button>
      </form>

      <div style="margin-top: 15px; text-align: right;">
        <a href="#" class="link-lupa" onclick="openAturUlangModal()">Lupa Kata Sandi?</a>
      </div>
    </div>

    <!-- CARD ATUR ULANG -->
    <div class="login-card hidden" id="card-reset">
      <div class="login-header-logo">
        <img src="https://drive.google.com/thumbnail?id=1kb_yesHbnVPtCrjzlWZGD_XXtfQoaLEe&sz=w600" alt="History Club 32">
      </div>

      <h2 class="login-title">Atur Ulang Kata Sandi</h2>
      <p class="login-subtitle" id="reset-subtitle">Memeriksa tautan atur ulang...</p>

      <div class="token-info" id="reset-info-box">
        <div class="token-grid">
          <div class="token-label">Status</div>
          <div class="token-value">
            <span class="token-pill" id="reset-status-pill">
              <i class="ri-loader-4-line"></i>
              <span id="reset-status-text">Memvalidasi token</span>
            </span>
          </div>

          <div class="token-label">Email</div>
          <div class="token-value muted" id="reset-email-text">-</div>

          <div class="token-label">Username</div>
          <div class="token-value muted" id="reset-user-text">-</div>

          <div class="token-label">Sisa waktu</div>
          <div class="token-value" id="reset-countdown-text">--:--</div>
        </div>
      </div>

      <form id="reset-form" onsubmit="event.preventDefault();">
        <div class="form-group">
          <label class="form-label">Kata Sandi Baru</label>
          <div class="input-wrapper">
            <i class="ri-lock-password-line input-icon"></i>
            <input id="reset-pass-1" type="password" class="form-input" placeholder="Minimal 8 karakter" autocomplete="new-password">
            <button type="button" class="toggle-eye toggle-reset" data-target="reset-pass-1" title="Lihat Kata Sandi">
              <i class="ri-eye-off-line"></i>
            </button>
          </div>
          <div class="pw-hint" id="pw-hint-1">
            <b>Aturan:</b> minimal 8 karakter, ada huruf besar, huruf kecil, angka, dan simbol. Tidak boleh memuat username.
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Ulangi Kata Sandi Baru</label>
          <div class="input-wrapper">
            <i class="ri-lock-password-line input-icon"></i>
            <input id="reset-pass-2" type="password" class="form-input" placeholder="Harus sama persis" autocomplete="new-password">
            <button type="button" class="toggle-eye toggle-reset" data-target="reset-pass-2" title="Lihat Kata Sandi">
              <i class="ri-eye-off-line"></i>
            </button>
          </div>
        </div>

        <button type="submit" id="btn-reset-submit" class="btn-login" disabled>Simpan Kata Sandi</button>

        <p class="small-note">Jika tautan atur ulang sudah kedaluwarsa, minta tautan baru.</p>

        <!-- pakai ./ supaya bisa tanpa index.html -->
        <a class="link-back" href="./">
          <i class="ri-arrow-left-line"></i> Kembali ke Login
        </a>
      </form>
    </div>

    <div class="help-card" id="help-card">
      <div style="flex:1;">
        <p class="help-title">Butuh Bantuan?</p>
        <p class="help-desc">Hubungi Ketua HC <a href="https://instagram.com/mickovoitto" target="_blank" class="help-link">@mickovoitto</a> jika mengalami kendala sistem.</p>
      </div>
      <a href="https://www.instagram.com/historyclub32jkt/" target="_blank" class="help-btn">
        Instagram HC 32
        <i class="ri-instagram-line"></i>
      </a>
    </div>

  </div>

  <!-- MODAL: MINTA TAUTAN ATUR ULANG -->
  <div class="modal-overlay" id="modal-otp-request">
    <div class="modal-card">
      <button class="modal-close" type="button" onclick="closeOtpModal()" aria-label="Tutup">&times;</button>

      <h3 style="margin:0; color:var(--hc-blue);">Atur Ulang Kata Sandi</h3>
      <p style="font-size:13px; color:#64748b; margin:10px 0 18px;">
        Masukkan ID Pengurus (Username/NIS/Email). Kami akan mengirimkan tautan atur ulang ke email yang terdaftar.
      </p>

      <input type="text" id="otp-username-req" class="form-input" placeholder="Masukkan ID Pengurus" style="text-align:center; margin-bottom:15px;">

      <button type="button" onclick="requestResetLink()" class="btn-login" id="btn-req-otp">Kirim Tautan</button>
    </div>
  </div>

  <!-- MODAL: OTP LOGIN -->
  <div class="modal-overlay" id="modal-otp-verify">
    <div class="modal-card">
      <h3 style="margin-top:0; color:var(--hc-blue);">Verifikasi Login</h3>
      <p style="font-size:13px; color:#64748b;">Masukkan 6 digit kode yang dikirim ke <br><strong id="otp-email-display">email</strong></p>

      <!-- countdown (tambahan) -->
      <p style="font-size:12px; color:#64748b; margin:8px 0 0;">
        Sisa waktu: <strong id="otp-countdown">--:--</strong>
      </p>

      <div class="otp-inputs" id="otp-container">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,1)">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,2)">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,3)">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,4)">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,5)">
        <input type="text" class="otp-input" maxlength="1" oninput="digitInput(this,6)">
      </div>

      <button type="button" id="btn-otp-verify" onclick="verifyOtp()" class="btn-login">Verifikasi & Masuk</button>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_URL = (typeof GAS_URL !== 'undefined') ? GAS_URL : "URL_APPS_SCRIPT_ANDA_DISINI";
    const DASHBOARD_BASE = "https://historyclub32.github.io/pengurus/dashboard.html";

    // =========================
    // HELPER: POST JSON (text/plain)
    // =========================
    async function postJson(payload){
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    // =========================
    // MODE DETECTOR (tautan atur ulang via email)
    // =========================
    const params = new URLSearchParams(window.location.search);
    const isResetMode = params.get('reset') === '1';         // query tetap "reset" (parameter URL), tapi teks UI jadi "atur ulang"
    const resetToken  = (params.get('token') || '').trim();

    const cardLogin = document.getElementById('card-login');
    const cardReset = document.getElementById('card-reset');

    if (isResetMode) {
      cardLogin?.classList.add('hidden');
      cardReset?.classList.remove('hidden');
    } else {
      cardReset?.classList.add('hidden');
      cardLogin?.classList.remove('hidden');
    }

    // =========================
    // SAFE STATUS GUARD
    // =========================
    function safeShowStatus(type, title, msg){
      if (typeof window.showHC32Status === 'function') window.showHC32Status(type, title, msg);
    }
    function safeHideStatus(){
      if (typeof window.hideHC32Status === 'function') window.hideHC32Status();
    }

    // =========================
    // TOGGLE EYE (login)
    // =========================
    function bindEyeButton(buttonEl, inputEl){
      if (!buttonEl || !inputEl) return;
      buttonEl.addEventListener('click', () => {
        const nextType = inputEl.type === 'password' ? 'text' : 'password';
        inputEl.type = nextType;

        const icon = buttonEl.querySelector('i');
        if (!icon) return;
        icon.classList.toggle('ri-eye-off-line');
        icon.classList.toggle('ri-eye-line');
      });
    }
    bindEyeButton(document.getElementById('toggle-password'), document.getElementById('login-password'));

    // toggle eye untuk field atur ulang (data-target)
    document.querySelectorAll('.toggle-reset').forEach(btn => {
      const id = btn.getAttribute('data-target');
      const inp = document.getElementById(id);
      bindEyeButton(btn, inp);
    });

    // =========================
    // GLOBALS (OTP)
    // =========================
    let currentOtpUser = '';

    // countdown OTP (tambahan)
    let otpCountdownTimer = null;
    let otpOffsetMs = 0;
    let otpExpiresAtMs = 0;

    // auto-submit (tambahan)
    let otpAutoSubmitTimer = null;
    let otpSubmitting = false;

    // =========================
    // OTP HELPERS (tambahan)
    // =========================
    function getOtpInputs_(){
      return Array.from(document.querySelectorAll('#otp-container .otp-input'));
    }

    function clearOtpInputs_(){
      const inputs = getOtpInputs_();
      inputs.forEach(i => i.value = '');
    }

    function setOtpInputsFromDigits_(digits, startIndex){
      const inputs = getOtpInputs_();
      const clean = String(digits || '').replace(/\D/g,'');
      if (!clean) return;

      let idx = Math.max(0, Math.min(inputs.length - 1, startIndex || 0));
      for (let k = 0; k < clean.length && idx < inputs.length; k++, idx++){
        inputs[idx].value = clean[k];
      }

      const nextEmpty = inputs.find(i => !i.value);
      (nextEmpty || inputs[inputs.length - 1])?.focus();
    }

    function otpGetCode_(){
      return getOtpInputs_().map(i => i.value || '').join('');
    }

    function stopOtpCountdown_(){
      if (otpCountdownTimer) clearInterval(otpCountdownTimer);
      otpCountdownTimer = null;
    }

    function startOtpCountdown_(serverNowMs, expiresAtMs){
      const el = document.getElementById('otp-countdown');
      const btn = document.getElementById('btn-otp-verify');
      if (!el) return;

      const sNow = Number(serverNowMs);
      const exp = Number(expiresAtMs);

      // kalau backend tidak mengirim, jangan jalanin countdown (tetap tampil --:--)
      if (!isFinite(sNow) || !isFinite(exp) || exp <= 0){
        el.textContent = '--:--';
        el.classList.remove('expired');
        return;
      }

      otpOffsetMs = sNow - Date.now();
      otpExpiresAtMs = exp;

      const fmt = (sec) => {
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      };

      const tick = () => {
        const nowServerApprox = Date.now() + otpOffsetMs;
        const leftSec = Math.max(0, Math.floor((otpExpiresAtMs - nowServerApprox) / 1000));

        el.textContent = fmt(leftSec);

        if (leftSec <= 0){
          el.classList.add('expired');
          if (btn) btn.disabled = true;
          stopOtpCountdown_();
          safeShowStatus('error', 'OTP Kedaluwarsa', 'Kode OTP sudah kedaluwarsa. Silakan login ulang untuk meminta OTP baru.');
          return;
        } else {
          el.classList.remove('expired');
          // tombol juga dikontrol oleh validasi 6 digit, jadi jangan paksa enable di sini
        }
      };

      stopOtpCountdown_();
      tick();
      otpCountdownTimer = setInterval(tick, 1000);
    }

    function isOtpExpired_(){
      if (!otpExpiresAtMs) return false;
      const nowServerApprox = Date.now() + otpOffsetMs;
      return otpExpiresAtMs - nowServerApprox <= 0;
    }

    function scheduleOtpAutoSubmit_(){
      const modal = document.getElementById('modal-otp-verify');
      if (!modal || !modal.classList.contains('active')) return;

      if (otpAutoSubmitTimer) clearTimeout(otpAutoSubmitTimer);
      otpAutoSubmitTimer = setTimeout(() => {
        const btn = document.getElementById('btn-otp-verify');
        const code = otpGetCode_();
        if (otpSubmitting) return;
        if (isOtpExpired_()) return;
        if (!btn || btn.disabled) return;
        if (code.length === 6){
          verifyOtp();
        }
      }, 200);
    }

    function initOtpEnhancements_(){
      const inputs = getOtpInputs_();
      const btn = document.getElementById('btn-otp-verify');

      // ENTER = klik verifikasi
      document.getElementById('modal-otp-verify')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter'){
          e.preventDefault();
          verifyOtp();
        }
      });

      const refreshBtnState = () => {
        const code = otpGetCode_();
        const disabledByDigits = (code.length < 6);
        const disabledByExpiry = isOtpExpired_();

        if (btn) btn.disabled = disabledByDigits || disabledByExpiry;

        // auto-submit saat sudah 6 digit
        if (!disabledByDigits && !disabledByExpiry){
          scheduleOtpAutoSubmit_();
        }
      };

      inputs.forEach((inp, index) => {
        // BACKSPACE lintas kotak
        inp.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace'){
            if (inp.value){
              inp.value = '';
              e.preventDefault();
              refreshBtnState();
              return;
            }
            const prev = inputs[index - 1];
            if (prev){
              prev.value = '';
              prev.focus();
              e.preventDefault();
              refreshBtnState();
            }
          }

          // Arrow nav (opsional)
          if (e.key === 'ArrowLeft' && inputs[index - 1]){
            inputs[index - 1].focus();
            e.preventDefault();
          }
          if (e.key === 'ArrowRight' && inputs[index + 1]){
            inputs[index + 1].focus();
            e.preventDefault();
          }
        });

        // PASTE: tempel 6 digit langsung isi semua kotak
        inp.addEventListener('paste', (e) => {
          const text = (e.clipboardData || window.clipboardData).getData('text') || '';
          const digits = text.replace(/\D/g,'');
          if (!digits) return;

          e.preventDefault();

          if (digits.length >= 6){
            clearOtpInputs_();
            setOtpInputsFromDigits_(digits.slice(0,6), 0);
          } else {
            setOtpInputsFromDigits_(digits, index);
          }

          refreshBtnState();
        });

        inp.addEventListener('input', refreshBtnState);
      });

      refreshBtnState();
    }

    // =========================
    // ATUR ULANG: UI refs
    // =========================
    const resetStatusText     = document.getElementById('reset-status-text');
    const resetStatusPill     = document.getElementById('reset-status-pill');
    const resetEmailText      = document.getElementById('reset-email-text');
    const resetUserText       = document.getElementById('reset-user-text');
    const resetSubtitle       = document.getElementById('reset-subtitle');
    const resetCountdownText  = document.getElementById('reset-countdown-text');
    const btnResetSubmit      = document.getElementById('btn-reset-submit');
    const resetForm           = document.getElementById('reset-form');

    const pass1El = document.getElementById('reset-pass-1');
    const pass2El = document.getElementById('reset-pass-2');

    let resetTokenValidated = false;
    let resetUsernameConfirmed = '';
    let resetExpiresAt = null;        // Date
    let countdownTimer = null;

    // =========================
    // VALIDASI KOMBINASI KATA SANDI
    // =========================
    function validateNewPassword_(pw, username){
      const s = String(pw || '');
      const u = String(username || '').trim();

      if (!s) return 'Kata sandi wajib diisi.';
      if (s.length < 8) return 'Minimal 8 karakter.';
      if (/\s/.test(s)) return 'Tidak boleh ada spasi.';

      const hasLower = /[a-z]/.test(s);
      const hasUpper = /[A-Z]/.test(s);
      const hasDigit = /[0-9]/.test(s);
      const hasSym   = /[^A-Za-z0-9]/.test(s);

      if (!hasUpper) return 'Harus ada huruf besar (A-Z).';
      if (!hasLower) return 'Harus ada huruf kecil (a-z).';
      if (!hasDigit) return 'Harus ada angka (0-9).';
      if (!hasSym)   return 'Harus ada simbol (contoh: !@#).';

      // jangan memuat username (kalau username cukup panjang)
      if (u && u.length >= 4){
        const uLower = u.toLowerCase();
        const sLower = s.toLowerCase();
        if (sLower.includes(uLower)) return 'Tidak boleh memuat username.';
      }

      // blokir kata sandi yang sangat umum
      const common = new Set([
        'password','password123','12345678','123456789','qwerty','qwerty123',
        'admin123','administrator','hc32','hc321234','iloveyou','bismillah'
      ]);
      if (common.has(s.toLowerCase())) return 'Kata sandi terlalu umum.';

      return null; // OK
    }

    // =========================
    // LIVE VALIDATION (border merah + shake)
    // =========================
    let pass1Touched = false;
    let pass2Touched = false;

    function setFieldError_(el, on){
      if (!el) return;
      if (on) el.classList.add('input-error');
      else el.classList.remove('input-error');
    }

    function getPwState_(){
      const p1 = (pass1El?.value || '').trim();
      const p2 = (pass2El?.value || '').trim();

      const err1 = !p1 ? 'Kata sandi wajib diisi.' : validateNewPassword_(p1, resetUsernameConfirmed);
      const err2 = !p2 ? 'Konfirmasi wajib diisi.' : (p1 !== p2 ? 'Konfirmasi harus sama persis.' : null);

      const countdownOk = !resetExpiresAt || (resetExpiresAt.getTime() - Date.now() > 0);
      const ok = resetTokenValidated && countdownOk && !err1 && !err2;

      return { p1, p2, err1, err2, ok, countdownOk };
    }

    function updateSubmitState_(){
      const st = getPwState_();
      if (btnResetSubmit) btnResetSubmit.disabled = !st.ok;
    }

    function renderPwErrors_(){
      const st = getPwState_();

      // field 1
      const show1 = pass1Touched && !!st.err1;
      setFieldError_(pass1El, show1);

      // field 2
      const show2 = pass2Touched && !!st.err2;
      setFieldError_(pass2El, show2);

      updateSubmitState_();
    }

    pass1El?.addEventListener('input', () => { pass1Touched = true; renderPwErrors_(); });
    pass1El?.addEventListener('blur',  () => { pass1Touched = true; renderPwErrors_(); });

    pass2El?.addEventListener('input', () => { pass2Touched = true; renderPwErrors_(); });
    pass2El?.addEventListener('blur',  () => { pass2Touched = true; renderPwErrors_(); });

    // =========================
    // COUNTDOWN 30 MENIT
    // Catatan: paling akurat kalau backend mengirim expiresAt/remainingSec.
    // Kalau tidak ada, countdown dihitung dari saat token dinyatakan valid di halaman ini.
    // =========================
    function formatMs_(ms){
      const totalSec = Math.max(0, Math.floor(ms / 1000));
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      const mm = String(m).padStart(2,'0');
      const ss = String(s).padStart(2,'0');
      return `${mm}:${ss}`;
    }

    function stopCountdown_(){
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
    }

    function startCountdown_(){
      stopCountdown_();
      function tick(){
        if (!resetExpiresAt){
          resetCountdownText.textContent = '--:--';
          return;
        }
        const left = resetExpiresAt.getTime() - Date.now();
        resetCountdownText.textContent = formatMs_(left);

        if (left <= 0){
          stopCountdown_();
          resetTokenValidated = false;
          updateSubmitState_();

          resetSubtitle && (resetSubtitle.innerText = 'Tautan atur ulang kedaluwarsa.');
          if (resetStatusText) resetStatusText.innerText = 'Tidak Valid';
          if (resetStatusPill){
            resetStatusPill.classList.remove('pill-ok');
            resetStatusPill.classList.add('pill-bad');
            resetStatusPill.querySelector('i')?.classList.remove('ri-shield-check-line');
            resetStatusPill.querySelector('i')?.classList.add('ri-error-warning-line');
          }
          safeShowStatus('error', 'Kedaluwarsa', 'Tautan atur ulang sudah kedaluwarsa. Silakan minta tautan baru.');
        }
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    // =========================
    // VERIFY TOKEN (atur ulang)
    // =========================
    async function verifyResetTokenFront_(){
      if (!isResetMode) return;

      if (!resetToken){
        resetSubtitle && (resetSubtitle.innerText = 'Token tidak ditemukan pada URL.');
        if (resetStatusText) resetStatusText.innerText = 'Tidak Valid';
        resetStatusPill?.classList.add('pill-bad');
        safeShowStatus('error', 'Token Tidak Ada', 'Tautan atur ulang tidak lengkap.');
        return;
      }

      safeShowStatus('loading', 'Memvalidasi...', 'Mohon tunggu sebentar.');

      try{
        const out = await postJson({ action: "verifyResetTokenAdmin", token: resetToken });

        if (out && out.status === 'ok' && out.valid === true){
          safeHideStatus();

          resetTokenValidated = true;
          resetUsernameConfirmed = out.username || '';
          // saran backend: kembalikan out.expiresAt (ISO string) ATAU out.remainingSec.
          // kalau tidak ada, fallback: 30 menit dari sekarang.
          if (out.expiresAt){
            resetExpiresAt = new Date(out.expiresAt);
          } else if (typeof out.remainingSec === 'number'){
            resetExpiresAt = new Date(Date.now() + out.remainingSec * 1000);
          } else {
            resetExpiresAt = new Date(Date.now() + 30 * 60 * 1000);
          }

          resetSubtitle && (resetSubtitle.innerText = 'Silakan buat kata sandi baru.');
          if (resetStatusText) resetStatusText.innerText = 'Token Valid';

          if (resetStatusPill){
            resetStatusPill.classList.remove('pill-bad');
            resetStatusPill.classList.add('pill-ok');
            const icon = resetStatusPill.querySelector('i');
            if (icon){
              icon.className = 'ri-shield-check-line';
            }
          }

          if (resetEmailText) resetEmailText.innerText = out.email || '(Terkonfirmasi)';
          if (resetUserText) resetUserText.innerText = out.username || '(Terkonfirmasi)';

          // start countdown + enable submit state (tergantung validasi password)
          startCountdown_();
          renderPwErrors_();

        } else {
          resetTokenValidated = false;
          resetUsernameConfirmed = '';
          resetExpiresAt = null;
          stopCountdown_();

          safeHideStatus();
          resetSubtitle && (resetSubtitle.innerText = 'Tautan atur ulang kedaluwarsa.');
          if (resetStatusText) resetStatusText.innerText = 'Tidak Valid';

          if (resetStatusPill){
            resetStatusPill.classList.remove('pill-ok');
            resetStatusPill.classList.add('pill-bad');
            const icon = resetStatusPill.querySelector('i');
            if (icon){
              icon.className = 'ri-error-warning-line';
            }
          }

          resetCountdownText.textContent = '--:--';
          updateSubmitState_();
          safeShowStatus('error', 'Gagal', (out && out.message) ? out.message : 'Token tidak valid.');
        }

      } catch (e){
        resetTokenValidated = false;
        resetUsernameConfirmed = '';
        resetExpiresAt = null;
        stopCountdown_();

        safeHideStatus();
        safeShowStatus('error', 'Koneksi Gagal', 'Gagal memvalidasi token. Coba refresh halaman.');
      }
    }

    // =========================
    // SUBMIT ATUR ULANG
    // =========================
    async function submitResetPasswordFront_(){
      if (!isResetMode) return;

      // paksa tampil error style kalau submit
      pass1Touched = true;
      pass2Touched = true;
      renderPwErrors_();

      const st = getPwState_();

      if (!resetTokenValidated){
        safeShowStatus('error', 'Token Tidak Valid', 'Refresh halaman dan coba lagi.');
        return;
      }

      if (!st.countdownOk){
        safeShowStatus('error', 'Kedaluwarsa', 'Tautan atur ulang sudah kedaluwarsa. Silakan minta tautan baru.');
        return;
      }

      if (st.err1){
        safeShowStatus('error', 'Kata Sandi Tidak Memenuhi Aturan', st.err1);
        pass1El?.focus();
        return;
      }

      if (st.err2){
        safeShowStatus('error', 'Konfirmasi Tidak Cocok', st.err2);
        pass2El?.focus();
        return;
      }

      safeShowStatus('loading', 'Menyimpan...', 'Mengubah kata sandi Anda.');

      try{
        const out = await postJson({
          action: "resetPasswordAdmin",
          token: resetToken,
          newPassword: st.p1
        });

        if (out && out.status === 'ok'){
          safeShowStatus('success', 'Berhasil!', 'Kata sandi diubah. Silakan login kembali.');

          stopCountdown_();

          setTimeout(() => {
            // balik ke folder (tanpa index.html)
            window.location.href = "./";
          }, 1600);
        } else {
          safeShowStatus('error', 'Gagal', (out && out.message) ? out.message : 'Gagal mengatur ulang kata sandi.');
        }
      } catch (e){
        safeShowStatus('error', 'Koneksi Gagal', e.message);
      }
    }

    resetForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      submitResetPasswordFront_();
    });

    // =========================
    // LOGIN FLOW (PASSWORD -> OTP)
    // =========================
    const loginForm = document.getElementById("login-form");
    if (loginForm){
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const u = document.getElementById("login-username").value.trim();
        const p = document.getElementById("login-password").value.trim();

        if (!u || !p){
          safeShowStatus('error', 'Data Belum Lengkap', 'Mohon isi ID dan Kata Sandi.');
          return;
        }

        safeShowStatus('loading', 'Memeriksa Akun...', 'Mohon tunggu sebentar.');

        try{
          const out = await postJson({ action: "loginAdmin", username: u, password: p });

          if (out.status === "otp_required"){
            safeHideStatus();
            currentOtpUser = out.real_username || u;
            document.getElementById('otp-email-display').innerText = out.email || 'email terdaftar';

            document.getElementById('modal-otp-request').classList.remove('active');
            document.getElementById('modal-otp-verify').classList.add('active');

            // reset input + countdown akurat dari backend
            otpSubmitting = false;
            clearOtpInputs_();
            startOtpCountdown_(out.serverNowMs, out.expiresAtMs);

            setTimeout(() => {
              initOtpEnhancements_();
              document.querySelector('.otp-input')?.focus();
            }, 50);

          } else if (out.status === "ok"){
            handleLoginSuccess(out);
          } else {
            safeShowStatus('error', 'Login Gagal', out.message);
          }

        } catch (err){
          console.error(err);
          safeShowStatus('error', 'Kesalahan Koneksi', 'Gagal menghubungi server.');
        }
      });
    }

    function handleLoginSuccess(out){
      safeShowStatus('success', 'Login Berhasil!', 'Mengarahkan ke Dashboard...');
      const url = new URL(DASHBOARD_BASE);
      url.searchParams.set("token", out.token);
      url.searchParams.set("u", out.username);
      url.searchParams.set("n", out.nama);
      url.searchParams.set("r", out.role);
      url.searchParams.set("t", out.tipe || "");
      url.searchParams.set("j", out.jabatan || "Admin");
      url.searchParams.set("f", out.foto || "");

      setTimeout(() => {
        window.open(url.toString(), "_blank");
        window.location.reload();
      }, 1500);
    }

    // =========================
    // MODAL: ATUR ULANG (minta tautan)
    // =========================
    window.openAturUlangModal = function(){
      document.getElementById('modal-otp-request').classList.add('active');
      const mainUser = document.getElementById('login-username')?.value;
      if (mainUser) document.getElementById('otp-username-req').value = mainUser;
    }

    window.closeOtpModal = function(){
      document.getElementById('modal-otp-request').classList.remove('active');
    }

    // =========================
    // OTP INPUT (revisi: support paste/autofill)
    // =========================
    window.digitInput = function(el, idx){
      const inputs = getOtpInputs_();
      const i = (idx || 1) - 1;

      const digits = String(el.value || '').replace(/\D/g,'');

      if (!digits){
        el.value = '';
        return;
      }

      if (digits.length > 1){
        el.value = '';
        setOtpInputsFromDigits_(digits, i);
        return;
      }

      el.value = digits[0];
      if (inputs[i + 1]) inputs[i + 1].focus();
    }

    window.requestResetLink = async function(){
      const user = document.getElementById('otp-username-req').value.trim();
      if (!user){
        safeShowStatus('error', 'Data Kosong', 'Masukkan ID Pengurus/Email/NIS.');
        return;
      }

      const btn = document.getElementById('btn-req-otp');
      const originalText = btn.innerText;
      btn.innerText = "Mengirim...";
      btn.disabled = true;

      try{
        const out = await postJson({ action: "requestOtpAdmin", username: user });

        if (out && out.status === 'ok'){
          window.closeOtpModal();
          safeShowStatus('success', 'Email Terkirim', 'Silakan cek email Anda untuk tautan atur ulang kata sandi.');
        } else {
          safeShowStatus('error', 'Gagal', (out && out.message) ? out.message : 'Terjadi kesalahan.');
        }
      } catch (e){
        safeShowStatus('error', 'Error', e.message);
      }

      btn.innerText = originalText;
      btn.disabled = false;
    }

    // =========================
    // OTP VERIFY
    // =========================
    window.verifyOtp = async function(){
      const btn = document.getElementById('btn-otp-verify');
      if (otpSubmitting) return;

      let code = otpGetCode_();

      if (code.length < 6){
        safeShowStatus('error', 'Kode Tidak Lengkap', 'Masukkan 6 digit kode OTP.');
        return;
      }

      if (isOtpExpired_()){
        safeShowStatus('error', 'OTP Kedaluwarsa', 'Kode OTP sudah kedaluwarsa. Silakan login ulang untuk meminta OTP baru.');
        if (btn) btn.disabled = true;
        return;
      }

      otpSubmitting = true;
      if (btn) btn.disabled = true;

      safeShowStatus('loading', 'Verifikasi...', 'Memeriksa kode OTP.');

      try{
        const out = await postJson({ action: "verifyOtpAdmin", username: currentOtpUser, otp: code });

        if (out && out.status === "ok"){
          handleLoginSuccess(out);
        } else {
          otpSubmitting = false;
          safeShowStatus('error', 'Verifikasi Gagal', (out && out.message) ? out.message : 'Kode OTP Salah.');
          clearOtpInputs_();
          document.querySelector('.otp-input')?.focus();

          // re-enable tombol (kalau belum kedaluwarsa)
          if (btn) btn.disabled = isOtpExpired_();
        }
      } catch (e){
        otpSubmitting = false;
        safeShowStatus('error', 'Error', e.message);
        if (btn) btn.disabled = isOtpExpired_();
      }
    }

    // =========================
    // INIT
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      initHC32Navigation('login');

      initOtpEnhancements_();

      if (isResetMode){
        verifyResetTokenFront_();
      }
    });
  </script>
</body>
</html>
