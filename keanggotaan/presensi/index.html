<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Presensi Kegiatan HC 32</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="../../config.js"></script>
  <script src="../../components.js"></script>

  <style>
    /* Style Spesifik Halaman Ini */
    :root {
       /* Fallback vars jika components.js belum load css */
       --hc-blue: #1a4787;
       --hc-bg: #e7e9ea;
    }

    body {
      background: var(--hc-bg);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      /* Reset default margin dari tailwind jika ada konflik */
      margin: 0; 
    }

    /* Penyesuaian Main agar rapi dengan Header Components */
    main {
      flex-grow: 1;
      padding-top: 20px; 
      width: 100%;
    }

    .scanner-frame {
      border: 2px solid #e5e7eb;
      border-radius: 1.25rem;
      overflow: hidden;
      background: #000;
      position: relative;
    }
  </style>
</head>
<body class="text-gray-800">

  <main class="max-w-5xl mx-auto px-4 pb-10 w-full">
    
    <div class="mb-6 mt-2 text-center md:text-left">
      <h1 class="text-2xl font-bold text-slate-800">Presensi Kegiatan</h1>
      <p class="text-slate-500 text-sm">Silakan pindai kode QR atau barcode kartu anggota.</p>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">

        <section class="bg-white rounded-2xl shadow-sm p-4 border border-gray-200">
          <h2 class="text-xl font-bold text-slate-800 mb-1">Kamera Pemindai</h2>
          <p class="text-sm text-gray-500 mb-4 flex items-center gap-2">
            <span class="w-10 h-[3px] bg-blue-800 inline-block rounded-full"></span>
            Aktifkan kamera untuk memindai.
          </p>

          <div id="camera-wrapper" class="scanner-frame mb-4 h-60 flex items-center justify-center">
            <div id="qr-reader" class="hidden w-full h-full [&_video]:w-full [&_video]:h-full [&_video]:object-cover"></div>
            <div id="qr-placeholder" class="flex flex-col items-center px-4 text-center">
              <p class="text-white/80 text-sm mb-2">Kamera belum aktif.</p>
              <p class="text-white/50 text-xs">Tekan tombol di bawah.</p>
            </div>
            <div id="scan-anim" class="absolute inset-6 rounded-xl border-2 border-white/70 pointer-events-none hidden">
              <div class="absolute inset-x-4 top-6 h-1 bg-white/60 shadow-[0_0_15px_2px_rgba(255,255,255,0.7)] animate-pulse"></div>
            </div>
          </div>

          <button id="btn-toggle-camera"
            class="w-full bg-blue-800 text-white font-semibold py-2.5 rounded-xl hover:bg-opacity-90 transition flex items-center justify-center gap-2 mb-1">
            
            <i id="icon-cam-start" class="ri-camera-line text-xl"></i>
            <i id="icon-cam-stop" class="ri-stop-circle-line text-xl hidden"></i>
            <span id="btn-toggle-text">Mulai Pindai Barcode</span>
          </button>
          <p class="text-[0.7rem] text-gray-400 mt-1 text-center">Pastikan browser mengizinkan akses kamera.</p>
        </section>

        <section class="flex flex-col gap-4">

          <div class="bg-white border border-gray-200 rounded-2xl p-4 flex gap-3 items-center shadow-sm">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 shrink-0">
               <i class="ri-qr-scan-2-line text-xl"></i>
            </div>
            <div class="flex-1 min-w-0">
              <p id="local-status-title" class="font-semibold text-sm text-slate-800 truncate">Menunggu presensi...</p>
              <p id="local-status-msg" class="text-xs text-slate-500">Arahkan kamera ke barcode.</p>
            </div>
          </div>

          <div class="bg-yellow-50 border border-yellow-200 rounded-2xl px-4 py-3 flex items-center gap-3 shadow-sm">
            <img src="https://drive.google.com/thumbnail?id=1kNumtFhyzrMmiwbQf_Xu7LWPhXMz2wHj&sz=w200" alt="Icon" class="w-9 h-9 object-contain opacity-80">
            <div>
              <p class="font-semibold text-yellow-900 text-sm">Info Presensi</p>
              <p class="text-xs text-yellow-800 leading-tight">Gunakan kartu anggota untuk presensi lebih cepat.</p>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-200">
            <h3 class="font-semibold text-slate-800 mb-1">Input Manual</h3>
            <p class="text-xs text-gray-500 mb-3">Jika barcode rusak atau tidak terbaca.</p>
            <div class="flex flex-col sm:flex-row gap-3">
              <input id="manual-nis" type="text" inputmode="numeric"
                     placeholder="Masukkan NIS/ID..."
                     class="flex-1 min-w-0 border border-gray-300 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:border-blue-800">
              <button id="btn-send-manual"
                      class="px-4 py-2 rounded-xl bg-blue-800 text-white text-sm font-semibold hover:bg-opacity-90 transition w-full sm:w-auto">
                Kirim
              </button>
            </div>
          </div>

          <div id="result-box" class="hidden bg-white rounded-2xl shadow-sm p-4 flex items-center gap-4 border border-gray-200 transition-all duration-300">
            <div id="result-avatar" class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold text-xl border-4 border-blue-800 overflow-hidden bg-cover bg-center shrink-0">
            </div>
            <div class="flex-1 min-w-0">
              <p id="result-name" class="font-bold text-slate-800 truncate">Nama Anggota</p>
              <p id="result-meta" class="text-sm text-gray-500">Pertemuan • Jam</p>
            </div>
          </div>

        </section>
    </div>

    <div class="mt-8 mb-6 bg-white rounded-2xl shadow-sm flex flex-col md:flex-row items-center justify-between gap-3 px-5 py-4 border-l-4 border-blue-800">
      <div>
        <p class="font-semibold text-slate-800 text-sm">Butuh Bantuan?</p>
        <p class="text-xs text-gray-500">Hubungi Ketua HC <span class="font-semibold text-blue-800">@vitezegi</span> jika mengalami kendala.</p>
      </div>
      <a href="https://www.instagram.com/historyclub32jkt/" target="_blank"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-800 text-white text-sm hover:bg-opacity-90 transition-colors shrink-0">
        <i class="ri-instagram-line"></i> Instagram HC 32
      </a>
    </div>

  </main>

  <audio id="sound-success" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQCAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRgCAADg/+4A/QD6APEA8gDzAPIA7wDrAO8A7ADoAOEA6QDoAOIA5QDjAOIA4QDdANMA1gDSANAAzADMANAAywC/AK8ArACqAKgApQCjAKMAoQChAJ0AmgCcAJoAmACWAI8AkwCPAI0AjQCOAIwAigCHAIYAhQCBAIEAgAB/AH4AfAB5AHgAdQB1AHMAbwBtAGwAaQBoAGUAZgBhAGAAXQBcAFoAWQBXAFUAVABSAFIAUQBOAE0ASgBIAEYARgBFAEMAPwA+ADsAOgA5ADYANAAzADEALwAuACsAKgApACcAJgAjACIAHwAeAB0AGwAaABgAFgAUABEAEQAQAA8ADQAMAAoACAAFAAMAAgAAAP8A/gD5APcA8wD0APMA8gDwAO0A7gDrAOsA6ADlAOQA5QDiAN8A3ADaANkAzwDPA NAAywDJAMQAwgC/ALsAuAC1AmYClQKJAoMChQMCAv8B/wH9AfwB+gH6AfYB9AHvAfAB8gHxAfAB8AHvAe4B6wHrAesB6AHnAOYA5ADiAOEA4ADfAN0A2wDXANkA1gDSAM0AygDFAL4AtwCtAKoApwCkAI8AiwCAAHsAbQBhAFgASwA/ACsAHP8A9ADUAKEAagBGAB4A/gDOAIwAXgBAACsAHP8A9gDUAKMAagBHAB4A/gDPAMAAugC1AMQAswCxALEAsgCxAK8ArQCvAK8AsQCwALIAswCyALQAtQC1ALUAtAC1ALUAtQC1ALQAtAC0ALMAsgCyALMAsgCyALMAsgCyALIAswCyALMAswCyALMAtACzALMAsgCzALMAsgCzALMAswCzALMAtAC0ALQAtQC1ALUAtQC1ALUAtQC1ALUAtQC1ALQAtAC0ALMAsgCyALMAsgCyALMAsgCyALIAswCyALMAswCyALMAtACzALMAsgCzALMAsgCzALMAswCzALMAsgCzALIAswCyALMAsgCyALMAswCzALIAswCzALMAsgCyALMAsgCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCyALMAswCyALMAsgCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALMAsgCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALMAsgCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALMAsgCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALIAswCzALMAsgCzALIAswCzALIAswCzAnalisa" type="audio/wav">
  </audio>
  <audio id="sound-error" preload="auto">
    <source src="data:audio/wav;base64,UklGRiwCAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YSAgAgAAMEBAgMDBw8XIycrMy8/S1NbX2Nna3N/h5Ofo6err7O/x9fb4+vv9/f8AAQECBg4KESQnKC0uLzM2Nzw9P0NHSUtOUFNVV1laW15gYWJjZGVmZ2lqa2xub3Bxc3R1dnd5ent9f4CBg4WHh4mKi4yNjo+QkZKTlJWXmJmbnJ2en6Gio6Slp6mqrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfa2drb3N3e3+Di4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3Bxc3R1dnd5ent9f4CBg4WHh4mKi4yNjo+QkZKTlJWXmJmbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsc=" type="audio/wav">
  </audio>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        // Inisialisasi Components (Header, Sidebar, Footer)
        if (typeof initHC32Navigation === 'function') {
            initHC32Navigation('presensi');
        }
    });

    // Gunakan URL dari config.js, atau fallback (untuk development)
    const API_URL = (typeof GAS_URL !== 'undefined') ? GAS_URL : "https://script.google.com/macros/s/AKfycbz22NwYQ-WJwmdieMgzQxw1I2lXKTghebFO-oSY-wE_av-3oEYIi9TfSCqJCpy3iZKt/exec";

    // DOM Elements
    const manualInput   = document.getElementById('manual-nis');
    const manualBtn     = document.getElementById('btn-send-manual');
    const resultBox     = document.getElementById('result-box');
    const resultName    = document.getElementById('result-name');
    const resultMeta    = document.getElementById('result-meta');
    const resultAvatar  = document.getElementById('result-avatar');
    
    // Camera Elements
    const btnToggleCamera = document.getElementById('btn-toggle-camera');
    const btnToggleText   = document.getElementById('btn-toggle-text');
    const iconCamStart    = document.getElementById('icon-cam-start');
    const iconCamStop     = document.getElementById('icon-cam-stop');
    const qrReaderDiv     = document.getElementById('qr-reader');
    const qrPlaceholder   = document.getElementById('qr-placeholder');
    const scanAnim        = document.getElementById('scan-anim');

    // Local Status (Hanya text di card, bukan pop-up)
    const localStatusTitle = document.getElementById('local-status-title');
    const localStatusMsg   = document.getElementById('local-status-msg');

    const soundSuccess  = document.getElementById('sound-success');
    const soundError    = document.getElementById('sound-error');

    let qrReader = null;
    let cameraOn = false;
    let lastScannedCode = "";
    let lastScanTime    = 0;

    // --- Helper: Update Status Card (Bukan Modal) ---
    function setLocalStatus(title, msg) {
        localStatusTitle.textContent = title;
        localStatusMsg.textContent = msg;
    }

    // --- Helper: Update Result Card ---
    function showResult(data) {
        resultBox.classList.remove('hidden');
        resultName.textContent = data.nama || 'Anggota';
        resultMeta.textContent = (data.pertemuan || '-') + ' • ' + (data.jam || '');
        
        resultAvatar.style.backgroundImage = 'none';
        resultAvatar.textContent = '';

        if (data.foto) {
            resultAvatar.style.backgroundImage = `url('${data.foto}')`;
        } else {
            const inisial = (data.nama || 'HC').substring(0, 2).toUpperCase();
            resultAvatar.textContent = inisial;
        }
    }

    /* ===== KIRIM PRESENSI ===== */
    async function sendPresensi(id, source) {
      const cleanId = (id || '').replace(/[^0-9]/g, ''); // Ambil angka saja
      
      if (!cleanId) {
        // Tampilkan Modal Error (Component.js)
        if(typeof window.showHC32Status === 'function') {
            window.showHC32Status('error', 'Input Kosong', 'Masukkan nomor identitas yang valid.');
        }
        soundError && soundError.play().catch(()=>{});
        return;
      }

      // Tampilkan Modal Loading (Component.js)
      if(typeof window.showHC32Status === 'function') {
          window.showHC32Status('loading', 'Memeriksa Data...', `ID: ${cleanId}`);
      }

      setLocalStatus('Mengirim...', `ID: ${cleanId}`);

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, 
          body: JSON.stringify({ action: 'presensi', nis: cleanId })
        });
        const json = await res.json();
        handlePresensiResponse(json);
      } catch (err) {
        // Coba GET jika POST gagal (CORS fallback)
        try {
            const url = `${API_URL}?action=presensi&nis=${encodeURIComponent(cleanId)}`;
            const res = await fetch(url);
            const json = await res.json();
            handlePresensiResponse(json);
        } catch (e2) {
            if(typeof window.showHC32Status === 'function') {
                window.showHC32Status('error', 'Gagal Terhubung', 'Periksa koneksi internet Anda.');
            }
            setLocalStatus('Gagal Terhubung', 'Coba lagi nanti.');
            soundError && soundError.play().catch(()=>{});
        }
      }
    }

    function handlePresensiResponse(json) {
      if (!json || !json.status) {
        if(typeof window.showHC32Status === 'function') window.showHC32Status('error', 'Error', 'Respon server tidak valid.');
        soundError && soundError.play().catch(()=>{});
        return;
      }

      if (json.status === 'ok') {
        if(typeof window.showHC32Status === 'function') window.showHC32Status('success', 'Berhasil!', `${json.nama}<br>${json.pertemuan || ''}`);
        setLocalStatus('Berhasil', json.nama);
        showResult(json);
        soundSuccess && soundSuccess.play().catch(()=>{});
        manualInput.value = ''; // Reset input
      } 
      else if (json.status === 'duplicate') {
        if(typeof window.showHC32Status === 'function') window.showHC32Status('error', 'Sudah Presensi', `Halo ${json.nama}, kamu sudah absen hari ini.`);
        setLocalStatus('Ditolak', 'Sudah absen sebelumnya.');
        showResult(json); // Tetap tampilkan data
        soundError && soundError.play().catch(()=>{});
      } 
      else if (json.status === 'not-registered') {
        if(typeof window.showHC32Status === 'function') window.showHC32Status('error', 'Tidak Terdaftar', `ID ${json.nis} tidak ditemukan.`);
        setLocalStatus('Tidak Dikenal', `ID: ${json.nis}`);
        resultBox.classList.add('hidden');
        soundError && soundError.play().catch(()=>{});
      } 
      else {
        if(typeof window.showHC32Status === 'function') window.showHC32Status('error', 'Gagal', json.message || 'Terjadi kesalahan.');
        setLocalStatus('Error', json.message);
        resultBox.classList.add('hidden');
        soundError && soundError.play().catch(()=>{});
      }
    }

    /* ===== INPUT MANUAL ===== */
    manualBtn.addEventListener('click', () => {
      sendPresensi(manualInput.value, 'manual');
    });
    manualInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendPresensi(manualInput.value, 'manual');
      }
    });

    /* ===== START/STOP KAMERA ===== */
    async function stopCamera() {
      if (!qrReader || !cameraOn) return;
      try {
        await qrReader.stop();
      } catch (err) {
        console.warn("Gagal stop kamera:", err);
      } finally {
        cameraOn = false;
        qrPlaceholder.classList.remove('hidden');
        qrReaderDiv.classList.add('hidden');
        scanAnim.classList.add('hidden');
        
        btnToggleText.textContent = 'Mulai Pindai Barcode';
        iconCamStart.classList.remove('hidden');
        iconCamStop.classList.add('hidden');
        
        setLocalStatus('Kamera Mati', 'Klik tombol untuk memindai.');
      }
    }

    async function startCamera() {
      if (cameraOn) return;
      try {
        qrPlaceholder.classList.add('hidden');
        qrReaderDiv.classList.remove('hidden');
        setLocalStatus('Mengaktifkan...', 'Mohon izinkan kamera.');

        if (!qrReader) {
          qrReader = new Html5Qrcode("qr-reader");
        }
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        await qrReader.start(
          { facingMode: "environment" },
          config,
          (decodedText) => { 
            const now = Date.now();
            // Debounce 3 detik agar tidak spam scan yang sama
            if (decodedText === lastScannedCode && (now - lastScanTime) < 3000) {
              return; 
            }
            lastScannedCode = decodedText;
            lastScanTime    = now;
            scanAnim.classList.remove('hidden'); // Efek visual scan
            
            // Panggil fungsi kirim
            sendPresensi(decodedText, 'scanner');
            
            // Hapus efek scan setelah 0.5s
            setTimeout(() => scanAnim.classList.add('hidden'), 500);
          },
          (errorMessage) => {} 
        );
        
        cameraOn = true;
        setLocalStatus('Memindai...', 'Arahkan kode ke kamera.');
        scanAnim.classList.remove('hidden'); // Tampilkan garis scan statis

        btnToggleText.textContent = 'Matikan Kamera';
        iconCamStart.classList.add('hidden');
        iconCamStop.classList.remove('hidden');

      } catch (err) {
        console.error(err);
        if(typeof window.showHC32Status === 'function') {
            window.showHC32Status('error', 'Kamera Error', 'Gagal mengakses kamera. Pastikan izin diberikan.');
        }
        setLocalStatus('Error Kamera', 'Gagal akses kamera.');
        
        // Reset UI
        qrPlaceholder.classList.remove('hidden');
        qrReaderDiv.classList.add('hidden');
        cameraOn = false;
      }
    }

    btnToggleCamera.addEventListener('click', () => {
      if (cameraOn) stopCamera();
      else startCamera();
    });

  </script>
</body>
</html>
