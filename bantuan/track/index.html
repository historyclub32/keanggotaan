<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lacak Status - HC 32</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="../../config.js"></script>
  <script src="../../components.js"></script>

  <style>
    :root{
      --hc-blue:#1a4787;
      --hc-toska:#0f8a94;
      --hc-dark:#2e2e2e;
      --hc-bg:#e7e9ea;
      --hc-red:#d30e14;
      --card:#ffffff;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow:0 10px 35px rgba(2, 6, 23, .08);
      --radius:18px;
      --accent: var(--hc-blue);
      --accent2: var(--hc-toska);
      --ok: #0f766e;
      --warn: #b45309;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background: #eaf2ff;
      color:#0f172a;
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content: flex-start;
      padding:40px 14px;
    }
    .shell{
      width:100%;
      max-width:900px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }
    .icon-btn{
      width:42px;height:42px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition:.15s;
    }
    .title{ font-size:24px; font-weight:800; margin:0; }

    /* Search Panel - Always Visible */
    .search-panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
    }
    .search-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .inp{
      width:100%; height:48px; border-radius:12px;
      border:1px solid #cbd5e1; padding:0 16px;
      font-family: inherit; font-size: 14px; outline: none;
    }
    .inp:focus{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(26,71,135,.1); }
    .btn{
      width: 100%; height:48px; border:none; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff; font-weight:800; cursor:pointer; margin-top: 15px;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }

    /* Result Grid - Hidden by default */
    .result-grid {
      display: none; /* Hidden until search is performed */
      grid-template-columns: 350px 1fr;
      gap: 20px;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      height: fit-content;
    }
    .panel-head{ padding:16px; border-bottom:1px solid var(--line); font-weight:800; font-size:14px; }

    /* List styling */
    .list-container { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .ticket{
      border:1px solid var(--line); border-radius:14px; padding:12px;
      cursor:pointer; transition:.15s; background:#fff;
    }
    .ticket.active{ border-color: var(--accent); background: rgba(26,71,135,.03); }
    .code{ font-size:10px; color:var(--muted); font-weight:700; text-transform:uppercase; }
    .subject{ font-size:13px; font-weight:800; margin:2px 0; }
    
    /* Detail styling */
    .detail{ padding:20px; }
    .badge{
      display:inline-flex; align-items:center; gap:5px;
      padding:4px 10px; border-radius:99px; font-size:11px; font-weight:800;
      background: #f1f5f9; margin-bottom: 10px;
    }
    .badge.blue { background: rgba(26,71,135,.1); color: var(--hc-blue); }
    .badge.toska { background: rgba(15,138,148,.1); color: var(--hc-toska); }

    .timeline { margin-top: 20px; position: relative; }
    .t-row { display: grid; grid-template-columns: 80px 20px 1fr; gap: 10px; padding-bottom: 20px; }
    .t-date { font-size: 10px; color: var(--muted); font-weight: 700; }
    .t-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; position: relative; z-index: 2; margin-top: 4px;}
    .t-dot.on { background: var(--hc-toska); box-shadow: 0 0 0 4px rgba(15,138,148,0.1); }
    .t-main { font-size: 12px; }
    .t-title { font-weight: 800; }
    .t-sub { color: var(--muted); font-size: 11px; }

    /* Mobile Responsive */
    @media (max-width: 880px){
      .result-grid { grid-template-columns: 1fr; }
      .search-row { grid-template-columns: 1fr; }
      .page { padding: 20px 10px; }
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <div class="page">
    <div class="shell">

      <div class="topbar">
        <div class="topbar-left">
          <button class="icon-btn" onclick="history.back()"><i class="ri-arrow-left-line"></i></button>
          <h1 class="title">Tracking</h1>
        </div>
        <button class="icon-btn" onclick="openSettings()"><i class="ri-settings-3-line"></i></button>
      </div>

      <div class="search-panel">
        <div class="search-row">
          <input id="inp-code" class="inp" placeholder="Kode Tracking (contoh: PA000123)" />
          <input id="inp-secret" class="inp" placeholder="4 Digit Terakhir No HP" />
        </div>
        <button id="btn-check" class="btn" onclick="lookup()">
          <i class="ri-search-2-line"></i> Cek Status
        </button>
      </div>

      <div class="result-grid" id="result-area">
        <div class="panel">
          <div class="panel-head">Permintaan Terkini</div>
          <div class="list-container" id="list-items">
            </div>
        </div>

        <div class="panel">
          <div class="panel-head">Detail Status</div>
          <div class="detail" id="detail-content">
            </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API_URL = (typeof GAS_URL !== 'undefined') ? GAS_URL : "URL_APPS_SCRIPT_ANDA_DISINI";
    let ALL_ITEMS = [];

    // Helper API
    async function apiCall(action, payload){
      if (typeof hc32_post === 'function') return await hc32_post(action, payload);
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...payload }) });
      return await res.json();
    }

    // Input Rules
    document.getElementById('inp-code').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0, 8);
    });
    document.getElementById('inp-secret').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g,'').slice(0, 4);
    });

    async function lookup(){
      const code = document.getElementById('inp-code').value.trim();
      const secret = document.getElementById('inp-secret').value.trim();

      if (!code || !secret) {
        alert("Harap isi kode tracking dan verifikasi No HP");
        return;
      }

      if (window.showHC32Status) window.showHC32Status('loading', 'Mencari...', 'Menghubungkan ke server');

      try {
        const out = await apiCall('trackRequest', { trackingCode: code, secret });

        if (out && out.status === 'ok' && out.request) {
          if (window.hideHC32Status) window.hideHC32Status();
          
          // Munculkan grid hasil
          document.getElementById('result-area').style.display = 'grid';
          
          const item = mapTrackOutToItem_(out);
          ALL_ITEMS = [item]; // Simpan hasil
          renderLists();
          renderDetail(item);
          
          // Scroll otomatis ke hasil pada mobile
          if(window.innerWidth < 880) {
              document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
          }
        } else {
          if (window.showHC32Status) window.showHC32Status('error', 'Tidak Ditemukan', 'Kode atau verifikasi tidak cocok');
        }
      } catch (e) {
        if (window.showHC32Status) window.showHC32Status('error', 'Koneksi Gagal', e.message);
      }
    }

    function renderLists() {
      const container = document.getElementById('list-items');
      container.innerHTML = ALL_ITEMS.map(item => `
        <div class="ticket active">
          <div class="code">${item.id}</div>
          <div class="subject">${item.title}</div>
          <div class="code" style="color:var(--hc-toska)">${item.statusLabel}</div>
        </div>
      `).join('');
    }

    function renderDetail(item) {
      const container = document.getElementById('detail-content');
      container.innerHTML = `
        <div class="badge blue">${item.type}</div>
        <div style="font-weight:800; font-size:18px; margin-bottom:5px;">${item.title}</div>
        <div class="code" style="margin-bottom:20px;">Update Terakhir: ${item.updatedAt}</div>
        
        <div style="background:#f8fafc; padding:15px; border-radius:12px; margin-bottom:20px; font-size:13px;">
          <strong>Catatan:</strong><br>${item.note}
        </div>

        <div class="timeline">
          ${item.events.map(ev => `
            <div class="t-row">
              <div class="t-date">${ev.at}</div>
              <div class="t-dot on"></div>
              <div class="t-main">
                <div class="t-title">${ev.title}</div>
                <div class="t-sub">${ev.sub}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Mapper (Simplified version of your logic)
    function mapTrackOutToItem_(out){
      const r = out.request || {};
      return {
        id: r.code || '-',
        type: 'Permintaan',
        title: r.title || 'Layanan HC32',
        updatedAt: r.updatedAt || '-',
        statusLabel: r.status || 'Diproses',
        note: r.publicNote || 'Sedang dalam peninjauan oleh tim admin.',
        events: out.events || []
      };
    }

    function openSettings(){ alert("Pengaturan akan tersedia segera."); }

    // Prefill if URL has code
    window.onload = () => {
      const qs = new URLSearchParams(location.search);
      if(qs.get('code')) {
        document.getElementById('inp-code').value = qs.get('code').toUpperCase();
      }
    };
  </script>
</body>
</html>
