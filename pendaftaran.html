<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pendaftaran Anggota HC 32</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  
  <script src="config.js"></script>
  <script src="components.js"></script>
  
  <style>
    /* HANYA CSS SPESIFIK FORM (Header & Footer sudah di components.js) */
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8fafc;
        color: #2e2e2e;
        margin: 0; padding: 0;
        display: flex; flex-direction: column; min-height: 100vh;
    }

    /* === MAIN CONTENT === */
    .main-wrapper { flex: 1; padding: 40px 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    
    .card {
        background: #ffffff; border-radius: 16px;
        box-shadow: 0 8px 30px rgba(26, 71, 135, 0.08);
        padding: 30px; border: 1px solid #cbd5e1;
    }
    
    .welcome-banner { 
        background: linear-gradient(135deg, var(--hc-blue) 0%, var(--hc-toska) 100%);
        color: #fff; padding: 24px; border-radius: 12px; margin-bottom: 28px;
        text-align: center;
    }
    .welcome-banner h2 { margin: 0 0 6px; font-size: 24px; font-weight: 700; }
    .welcome-banner p { margin: 0; opacity: 0.9; font-size: 14px; font-weight: 300; }

    /* Form Elements */
    .row { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #2e2e2e; }
    input, select {
        width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1;
        border-radius: 10px; font-size: 15px; outline: none;
        background: #fff; box-sizing: border-box; transition: 0.2s;
        font-family: 'Poppins', sans-serif;
    }
    input:focus, select:focus { border-color: var(--hc-blue); box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.15); }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .hidden { display: none; }
    .note { font-size: 12px; color: #64748b; margin-top: 6px; }

    button[type="submit"] {
        width: 100%; background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska));
        color: #fff; border: none; padding: 16px; border-radius: 10px;
        font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px;
        box-shadow: 0 4px 15px rgba(15, 138, 148, 0.3); transition: 0.2s;
    }
    button[type="submit"]:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(15, 138, 148, 0.4); }
    button[type="submit"]:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Upload UI */
    .photo-area { border: 2px dashed var(--hc-toska); border-radius: 12px; padding: 20px; text-align: center; background: #f0f9fa; }
    #foto-preview-container { width: 130px; height: 130px; margin: 0 auto 16px; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; background: #ddd; }
    #foto-preview-img { width: 100%; height: 100%; object-fit: cover; }
    
    .photo-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 12px; }
    
    /* Tombol Utama Kamera di Form */
    .btn-cam-trigger {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid var(--hc-blue);
        background: white;
        color: var(--hc-blue);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }
    .btn-cam-trigger:hover { background: #f0f9ff; }
    .btn-cam-trigger.active { background: var(--hc-blue); color: white; border-color: var(--hc-blue); }

    .btn-small {
        padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
        border: 1px solid var(--hc-blue); color: var(--hc-blue);
        background: #fff; cursor: pointer; display: flex; align-items: center; gap: 6px;
        transition: 0.2s;
    }
    .btn-small:hover { background: var(--hc-blue); color: #fff; }
    .btn-small.danger { color: var(--hc-red); border-color: var(--hc-red); }
    .btn-small.danger:hover { background: var(--hc-red); color: #fff; }

    /* Signature */
    .sig-wrapper { height: 180px; border: 1px solid #cbd5e1; border-radius: 10px; position: relative; background: #fff; }
    canvas#sig-canvas { width: 100%; height: 100%; display: block; }
    .sig-clear-btn { position: absolute; top: 10px; right: 10px; z-index: 10; }

    /* === POP-UP NOTIFIKASI === */
    .status-modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000;
        display: none; align-items: center; justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }
    .status-modal-box {
        background: white; padding: 30px; border-radius: 20px;
        width: 90%; max-width: 320px; text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transform: scale(0.9); animation: scaleUp 0.3s ease-out forwards;
    }
    @keyframes scaleUp { to { transform: scale(1); } }
    .status-icon-circle { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .status-icon-circle.success { border: 4px solid var(--hc-green); }
    .status-icon-circle.error { border: 4px solid var(--hc-red); }
    .status-icon-svg { width: 40px; height: 40px; stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .success .status-icon-svg { stroke: var(--hc-green); }
    .error .status-icon-svg { stroke: var(--hc-red); }
    .status-title { font-size: 20px; font-weight: 700; color: #2e2e2e; margin-bottom: 8px; }
    .status-desc { font-size: 14px; color: #64748b; margin-bottom: 24px; line-height: 1.5; }
    .status-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--hc-blue); color: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; }
    .status-btn:hover { background: #153a6f; }

    /* === LOADER === */
    #hc32-loading-overlay {
        position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px); display: none;
        flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
    }
    .hc-loader { position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .hc-loader-spinner { position: absolute; inset: 0; border-radius: 50%; border: 5px solid var(--hc-blue); border-top-color: var(--hc-toska); animation: hcspin 1s linear infinite; }
    .hc-loader-logo { width: 50px; height: 50px; border-radius: 50%; object-fit: contain; }
    .hc-loader-text { font-size: 16px; font-weight: 600; color: #2e2e2e; }
    @keyframes hcspin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* === NEW CAMERA UI (Full Overlay Style) === */
    #cam-interface {
        position: fixed; inset: 0; background: #000; z-index: 5000;
        display: none; flex-direction: column;
    }
    .cam-header {
        padding: 20px; display: flex; justify-content: flex-end;
        position: absolute; top: 0; left: 0; right: 0; z-index: 10;
    }
    .btn-cam-close {
        background: rgba(0,0,0,0.5); border: none; color: white;
        width: 40px; height: 40px; border-radius: 50%; font-size: 24px;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .cam-viewport {
        flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
    }
    #cam-video {
        width: 100%; height: 100%; object-fit: cover;
    }
    /* Canvas untuk capture (hidden) */
    #cam-canvas { display: none; }
    
    /* Image Preview Overlay (di atas video saat dijepret) */
    #cam-result-img {
        position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
        display: none; z-index: 5;
    }

    .cam-controls {
        height: 120px; background: rgba(0,0,0,0.8);
        display: flex; align-items: center; justify-content: center;
        position: relative; gap: 40px;
    }

    /* Tombol Jepret (Tengah) */
    .btn-shutter {
        width: 70px; height: 70px; border-radius: 50%;
        background: white; border: 4px solid rgba(255,255,255,0.3);
        cursor: pointer; transition: transform 0.1s;
    }
    .btn-shutter:active { transform: scale(0.9); }

    /* Tombol Switch Camera (Kanan) - Hanya Mobile */
    .btn-switch {
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(255,255,255,0.2); border: none; color: white;
        font-size: 20px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        position: absolute; right: 30px;
    }
    
    /* Tombol Aksi Setelah Jepret (Hapus & Upload) */
    .cam-actions-after {
        display: none; width: 100%; justify-content: space-evenly; align-items: center;
    }
    .btn-action-cam {
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        background: none; border: none; color: white; cursor: pointer; font-size: 12px;
    }
    .icon-circle {
        width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; margin-bottom: 5px;
    }
    .btn-delete-cam .icon-circle { background: #ef4444; }
    .btn-upload-cam .icon-circle { background: #22c55e; }

    /* Cropper Modal (Tetap Ada) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5100; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { width: 100%; max-width: 400px; background: #202124; border-radius: 12px; overflow: hidden; padding: 16px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
    .btn-modal { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-modal.cancel { background: #333; color: white; }
    .btn-modal.confirm { background: #8ab4f8; color: #202124; }
    #cropper-img { max-width: 100%; display: block; }

    @media (min-width: 768px) {
        /* Sembunyikan switch camera di Desktop */
        .btn-switch { display: none; }
    }
    @media (max-width: 600px) {
        .two-col { grid-template-columns: 1fr; }
        .card { padding: 20px; }
    }
  </style>
</head>
<body>

  <div id="hc32-loading-overlay">
      <div class="hc-loader">
          <div class="hc-loader-spinner"></div>
          <img src="https://lh3.googleusercontent.com/d/16VXxbcOF9h5zAzYEo2faAzmgqqhtHLlH" class="hc-loader-logo" alt="Logo HC">
      </div>
      <div class="hc-loader-text" id="loading-text">Memproses data...</div>
  </div>

  <div id="status-modal" class="status-modal-overlay">
      <div class="status-modal-box">
          <div id="status-icon-container" class="status-icon-circle success"></div>
          <h3 id="status-title" class="status-title">Berhasil!</h3>
          <p id="status-desc" class="status-desc">Data Anda telah tersimpan.</p>
          <button id="status-btn" class="status-btn">Oke</button>
      </div>
  </div>

  <div class="main-wrapper">
      <div class="container">
          <div class="card">
              <div class="welcome-banner">
                  <h2>Formulir Pendaftaran</h2>
                  <p>Bergabunglah bersama kami untuk belajar dan berkembang.</p>
              </div>

              <form id="form-daftar" novalidate>
                  <div class="row">
                      <label for="fd-nis" id="label-id">NIS / Identitas *</label>
                      <input id="fd-nis" placeholder="Nomor Induk Siswa" required />
                  </div>
                  <div class="row">
                      <label for="fd-nama">Nama Lengkap *</label>
                      <input id="fd-nama" placeholder="Sesuai Absen/Dapodik" required autocapitalize="words" />
                  </div>
                  <div class="row">
                      <label for="fd-tipe">Tipe Keanggotaan *</label>
                      <select id="fd-tipe">
                          <option value="siswa">Siswa Aktif SMAN 32</option>
                          <option value="guru">Guru/Tendik</option>
                          <option value="alumni">Alumni</option>
                          <option value="lain">Lainnya (Non-32)</option>
                      </select>
                  </div>

                  <div id="group-siswa" class="row">
                      <div class="two-col">
                          <div>
                              <label>Kelas *</label>
                              <select id="fd-kelas"><option value="">Pilih...</option></select>
                          </div>
                          <div>
                              <label>Angkatan *</label>
                              <select id="fd-angkatan"><option value="">Pilih...</option></select>
                          </div>
                      </div>
                  </div>

                  <div id="group-jabatan" class="row hidden">
                      <label>Jabatan</label>
                      <input id="fd-jabatan" placeholder="Contoh: Pembina" />
                  </div>
                  <div id="group-lulus" class="row hidden">
                      <label>Tahun Lulus</label>
                      <input id="fd-thn-lulus" type="number" placeholder="YYYY" />
                  </div>

                  <div class="two-col row">
                      <div>
                          <label>No HP (WA) *</label>
                          <input id="fd-nohp" type="tel" placeholder="08..." required />
                      </div>
                      <div>
                          <label>Tanggal Lahir</label>
                          <input id="fd-tgllahir" type="date" />
                      </div>
                  </div>
                  <div class="row">
                      <label>Email (Opsional)</label>
                      <input id="fd-email" type="email" placeholder="email@address.com" />
                  </div>

                  <div class="row" style="margin-top:30px">
                      <label>Foto Profil (Wajib, 1:1)</label>
                      <div class="photo-area">
                          
                          <div id="foto-preview-container">
                              <img id="foto-preview-img" src="" alt="Preview">
                          </div>
                          
                          <input type="file" id="inp-file-foto" accept="image/*" hidden>
                          <input type="hidden" id="fd-foto-base64">
                          
                          <div class="photo-btn-group" id="photo-buttons">
                              <button type="button" class="btn-cam-trigger" id="btn-open-cam-main">
                                  <span>üì∑</span> Aktifkan Kamera / Upload
                              </button>
                          </div>

                          <div class="photo-btn-group hidden" id="photo-delete-group">
                               <button type="button" class="btn-small danger" id="btn-hapus-foto">Hapus Foto</button>
                          </div>
                      </div>
                  </div>

                  <div class="row">
                      <label>Tanda Tangan Digital *</label>
                      <div class="sig-wrapper">
                          <canvas id="sig-canvas"></canvas>
                          <button type="button" class="btn-small danger sig-clear-btn" id="sig-clear">Ulangi</button>
                      </div>
                      <p class="note">Goreskan tanda tangan pada kotak di atas.</p>
                  </div>

                  <button type="submit" id="btn-submit">Kirim Data</button>
              </form>
          </div>
      </div>
  </div>

  <div id="cam-interface">
      <div class="cam-header">
          <button class="btn-cam-close" id="btn-cam-close">√ó</button>
      </div>
      
      <div class="cam-viewport">
          <video id="cam-video" autoplay playsinline muted></video>
          <canvas id="cam-canvas"></canvas>
          <img id="cam-result-img" alt="Captured">
      </div>

      <div class="cam-controls">
          <div id="cam-controls-capture" style="display:flex; width:100%; justify-content:center; align-items:center;">
              <button class="btn-shutter" id="btn-cam-capture"></button>
              <button class="btn-switch" id="btn-cam-switch">üîÑ</button>
          </div>

          <div id="cam-controls-actions" class="cam-actions-after">
              <button class="btn-action-cam btn-delete-cam" id="btn-cam-retake">
                  <div class="icon-circle">üóëÔ∏è</div>
                  <span>Hapus</span>
              </button>
              <button class="btn-action-cam btn-upload-cam" id="btn-cam-confirm">
                  <div class="icon-circle">‚úÖ</div>
                  <span>Upload</span>
              </button>
          </div>
      </div>
  </div>

  <div id="crop-modal" class="modal-overlay">
      <div class="modal-box">
          <h3 style="margin:0 0 10px; color:#e8eaed; text-align:center; font-size:16px;">Sesuaikan Foto (1:1)</h3>
          <div style="height: 300px; width: 100%;">
              <img id="cropper-img" src="" style="max-width: 100%;">
          </div>
          <div class="modal-actions">
              <button class="btn-modal cancel" id="btn-crop-cancel">Batal</button>
              <button class="btn-modal confirm" id="btn-crop-save">Simpan</button>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    // ==== INIT NAVIGASI ====
    document.addEventListener('DOMContentLoaded', () => {
        initHC32Navigation('pendaftaran'); 
    });

    // ==== UI LOGIC (LOADER & POPUP) ====
    const loader = document.getElementById("hc32-loading-overlay");
    const loadingText = document.getElementById("loading-text");
    const statusModal = document.getElementById('status-modal');
    const statusTitle = document.getElementById('status-title');
    const statusDesc = document.getElementById('status-desc');
    const statusIconContainer = document.getElementById('status-icon-container');
    const statusBtn = document.getElementById('status-btn');

    function showLoader(text) { loadingText.textContent = text; loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }

    function showStatusPopup(type, title, message) {
        statusModal.style.display = 'flex';
        statusTitle.textContent = title;
        statusDesc.textContent = message;
        statusIconContainer.className = 'status-icon-circle ' + type;
        let svgContent = (type === 'success') ? 
            '<svg class="status-icon-svg" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>' : 
            '<svg class="status-icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        statusIconContainer.innerHTML = svgContent;
    }
    statusBtn.addEventListener('click', () => { statusModal.style.display = 'none'; });

    // ==== FORM LOGIC (Tipe Anggota) ====
    const MAX_FILE_SIZE_MB = 1;
    const tipeSel = document.getElementById('fd-tipe');
    const grpSiswa = document.getElementById('group-siswa');
    const grpJab = document.getElementById('group-jabatan');
    const grpLulus = document.getElementById('group-lulus');
    const nisInput = document.getElementById('fd-nis');
    const nisLabel = document.getElementById('label-id');

    function populateDropdowns() {
        const kelasSelect = document.getElementById('fd-kelas');
        const tingkat = ['X', 'XI', 'XII'];
        while (kelasSelect.options.length > 1) kelasSelect.remove(1);
        tingkat.forEach(t => {
            for(let i=1; i<=8; i++) kelasSelect.add(new Option(`${t}-${i}`, `${t}-${i}`));
        });
        const angkatanSelect = document.getElementById('fd-angkatan');
        const tahun = [2026, 2027, 2028];
        while (angkatanSelect.options.length > 1) angkatanSelect.remove(1);
        tahun.forEach(yr => angkatanSelect.add(new Option(yr, yr)));
    }

    function applyTypeUI() {
        const v = tipeSel.value;
        grpSiswa.classList.add('hidden'); grpJab.classList.add('hidden'); grpLulus.classList.add('hidden');
        let labelText = 'NIS / Identitas *'; let phText = 'Masukkan Nomor Identitas';

        if (v === 'siswa') { 
            grpSiswa.classList.remove('hidden'); labelText = 'NIS *'; phText = 'NIS (Max 7 Digit)';
        } else if (v === 'guru') {
            grpJab.classList.remove('hidden'); grpLulus.classList.remove('hidden'); labelText = 'NIP *'; phText = 'NIP (18 Digit)';
        } else if (v === 'alumni') {
            grpLulus.classList.remove('hidden'); labelText = 'No Anggota Perpus *'; phText = 'Nomor Anggota Lama';
        } else { 
            grpJab.classList.remove('hidden'); labelText = 'Identitas (NISN/NIP) *'; phText = 'NISN atau NIP';
        }
        nisLabel.textContent = labelText;
        nisInput.placeholder = phText;
    }
    tipeSel.addEventListener('change', applyTypeUI);

    // ==========================================
    // ==== LOGIKA KAMERA & UPLOAD BARU ====
    // ==========================================
    const btnOpenCamMain = document.getElementById('btn-open-cam-main');
    const camInterface = document.getElementById('cam-interface');
    const video = document.getElementById('cam-video');
    const canvas = document.getElementById('cam-canvas');
    const resultImg = document.getElementById('cam-result-img');
    
    // Tombol Kontrol Kamera
    const btnCloseCam = document.getElementById('btn-cam-close');
    const btnCapture = document.getElementById('btn-cam-capture');
    const btnSwitch = document.getElementById('btn-cam-switch');
    const btnRetake = document.getElementById('btn-cam-retake');
    const btnConfirm = document.getElementById('btn-cam-confirm');
    
    const divCapture = document.getElementById('cam-controls-capture');
    const divActions = document.getElementById('cam-controls-actions');

    // Cropper & Preview Utama
    const cropModal = document.getElementById('crop-modal');
    const cropperImg = document.getElementById('cropper-img');
    const btnCropSave = document.getElementById('btn-crop-save');
    const btnCropCancel = document.getElementById('btn-crop-cancel');
    const hiddenBase64 = document.getElementById('fd-foto-base64');
    const previewCont = document.getElementById('foto-preview-container');
    const previewImgMain = document.getElementById('foto-preview-img');
    const photoBtns = document.getElementById('photo-buttons');
    const photoDelGroup = document.getElementById('photo-delete-group');
    const btnHapusFoto = document.getElementById('btn-hapus-foto');

    let stream = null;
    let facingMode = 'user'; // Default kamera depan
    let cropper = null;

    // 1. Buka Kamera
    btnOpenCamMain.addEventListener('click', async () => {
        // Ganti teks tombol jadi "Non-Aktifkan" (atau langsung buka modal)
        // Di sini kita langsung buka modal sesuai request
        try {
            await startCamera();
            camInterface.style.display = 'flex';
            resetCamUI(); // Pastikan tombol jepret yg muncul
        } catch(e) {
            alert("Gagal mengakses kamera. Izinkan akses atau gunakan file upload.");
        }
    });

    // 2. Fungsi Start Camera
    async function startCamera() {
        if (stream) stopCamera();
        const constraints = {
            video: {
                facingMode: facingMode,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
    }

    function stopCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    // 3. Tutup Kamera
    btnCloseCam.addEventListener('click', () => {
        stopCamera();
        camInterface.style.display = 'none';
    });

    // 4. Switch Camera (Mobile)
    btnSwitch.addEventListener('click', async () => {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        await startCamera();
    });

    // 5. Jepret Foto
    btnCapture.addEventListener('click', () => {
        if (!stream) return;
        
        // Setup Canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Flip jika kamera depan agar mirror effect natural
        if (facingMode === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0);
        
        // Tampilkan Hasil di Overlay Image
        const dataURL = canvas.toDataURL('image/jpeg');
        resultImg.src = dataURL;
        resultImg.style.display = 'block';
        video.pause(); // Hentikan video sementara (opsional, karena tertutup img)

        // Ganti Tombol Kontrol
        divCapture.style.display = 'none';
        divActions.style.display = 'flex';
    });

    // 6. Hapus / Retake
    btnRetake.addEventListener('click', () => {
        resultImg.style.display = 'none'; // Sembunyikan hasil foto
        video.play(); // Putar video lagi
        resetCamUI();
    });

    function resetCamUI() {
        divCapture.style.display = 'flex';
        divActions.style.display = 'none';
        resultImg.style.display = 'none';
    }

    // 7. Upload / Konfirmasi -> Masuk ke Cropper
    btnConfirm.addEventListener('click', () => {
        // Ambil data dari canvas capture tadi
        const rawImg = resultImg.src;
        
        // Tutup kamera & modal kamera
        stopCamera();
        camInterface.style.display = 'none';

        // Buka Cropper
        startCropper(rawImg);
    });

    // --- CROPPER LOGIC ---
    function startCropper(imageSrc) {
        cropperImg.src = imageSrc;
        cropModal.style.display = 'flex';
        if(cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, { aspectRatio: 1, viewMode: 1 });
    }

    btnCropCancel.addEventListener('click', () => {
        cropModal.style.display = 'none';
        if(cropper) cropper.destroy();
    });

    btnCropSave.addEventListener('click', () => {
        if(!cropper) return;
        const cvs = cropper.getCroppedCanvas({ width: 600, height: 600, fillColor: '#fff' });
        cvs.toBlob(blob => {
            if(blob.size / 1024 / 1024 > MAX_FILE_SIZE_MB) {
                // Kompres jika > 1MB
                cvs.toBlob(b2 => finalizePhoto(b2), 'image/jpeg', 0.7);
            } else {
                finalizePhoto(blob);
            }
        }, 'image/jpeg', 0.9);
    });

    function finalizePhoto(blob) {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            hiddenBase64.value = reader.result;
            previewImgMain.src = reader.result;
            previewCont.style.display = 'block';
            
            // Ubah tampilan tombol utama
            photoBtns.classList.add('hidden');
            photoDelGroup.classList.remove('hidden');
            
            cropModal.style.display = 'none';
            if(cropper) cropper.destroy();
        }
    }

    // Hapus Foto Utama (Reset ke awal)
    btnHapusFoto.addEventListener('click', () => {
        hiddenBase64.value = ''; 
        previewImgMain.src = '';
        previewCont.style.display = 'none';
        
        photoBtns.classList.remove('hidden');
        photoDelGroup.classList.add('hidden');
    });

    // ==== SIGNATURE ====
    const sigCanvas = document.getElementById('sig-canvas');
    let signaturePad = null;

    function initSig() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        sigCanvas.width = sigCanvas.offsetWidth * ratio;
        sigCanvas.height = sigCanvas.offsetHeight * ratio;
        sigCanvas.getContext("2d").scale(ratio, ratio);
        if(signaturePad) signaturePad.clear();
    }
    window.addEventListener('resize', initSig);
    document.getElementById('sig-clear').addEventListener('click', () => signaturePad.clear());

    // ==== INIT & SUBMIT ====
    window.addEventListener('load', () => {
        populateDropdowns();
        applyTypeUI();
        signaturePad = new SignaturePad(sigCanvas, { backgroundColor: 'rgba(255,255,255,0)' });
        initSig();
    });

    document.getElementById('form-daftar').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if(signaturePad.isEmpty()) { 
            showStatusPopup('error', 'Tanda Tangan Kosong', 'Harap tanda tangan terlebih dahulu.'); return; 
        }
        if(!hiddenBase64.value) { 
            showStatusPopup('error', 'Foto Kosong', 'Harap ambil/upload foto profil.'); return; 
        }

        const btn = document.getElementById('btn-submit');
        btn.disabled = true; btn.textContent = 'Mengirim...';
        showLoader("Mengirim Data Pendaftaran...");

        try {
            const tipe = tipeSel.value === 'siswa' ? 'siswa-aktif' : 
                         tipeSel.value === 'lain' ? 'non-32' : tipeSel.value;
            const rawId = nisInput.value.trim().replace(/\D+/g, '');
            
            let pl = { nis:'', nisn:'', nip:'' };
            if(tipe==='siswa-aktif') pl.nis = rawId;
            else if(tipe==='guru') { pl.nip = rawId; pl.nis = rawId.slice(-7); }
            else if(tipe==='alumni') pl.nis = rawId;
            else if(tipe==='non-32') {
                if(rawId.length===18) { pl.nip=rawId; pl.nis=rawId.slice(-7); }
                else if(rawId.length===10) { pl.nisn=rawId; pl.nis=rawId.slice(-7); }
                else pl.nis = rawId;
            }

            const data = {
                ...pl,
                nama: document.getElementById('fd-nama').value.trim(),
                tipe: tipe,
                kelas: tipe === 'siswa-aktif' ? document.getElementById('fd-kelas').value : '',
                angkatan: tipe === 'siswa-aktif' ? document.getElementById('fd-angkatan').value : '',
                nohp: document.getElementById('fd-nohp').value.trim(),
                email: document.getElementById('fd-email').value.trim(),
                fotoBase64: hiddenBase64.value,
                jabatan: (tipe!=='siswa-aktif' && tipe!=='alumni') ? document.getElementById('fd-jabatan').value.trim() : '',
                tahunLulus: (tipe==='alumni' || tipe==='guru') ? document.getElementById('fd-thn-lulus').value.trim() : '',
                tanggalLahir: document.getElementById('fd-tgllahir').value,
                tandaTangan: signaturePad.toDataURL('image/png')
            };

            const res = await hc32_post('pendaftaran', data);

            if(res.status === 'ok') {
                showStatusPopup('success', 'Pendaftaran Berhasil', 'Data Anda telah berhasil disimpan. Terima kasih!');
                e.target.reset(); signaturePad.clear(); btnHapusFoto.click(); applyTypeUI();
            } else if (res.status === 'already') {
                showStatusPopup('error', 'Gagal Mendaftar', 'Nomor Identitas ini sudah terdaftar sebelumnya.');
            } else {
                showStatusPopup('error', 'Terjadi Kesalahan', 'Gagal: ' + res.message);
            }

        } catch(err) {
            showStatusPopup('error', 'Error Jaringan', err.message);
        } finally {
            hideLoader();
            btn.disabled = false; btn.textContent = 'Kirim Data';
        }
    });
  </script>
</body>
</html>
