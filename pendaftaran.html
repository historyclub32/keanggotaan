<!doctype html>
<html lang="id">
<head>
  <title>Pendaftaran Anggota HC 32</title>
  <script src="config.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  
  <style>
    :root {
      --brand-1: #1a4787; --brand-2: #0f8a94; --brand: #005A9C;
      --ink: #0f172a; --muted: #64748b; --border: #cbd5e1; --page: #e2e8f0; --card: #ffffff;
      --danger: #ef4444;
    }
    body{margin:0;font-family:'Poppins',system-ui,-apple-system,sans-serif;background:var(--page);color:var(--ink);-webkit-text-size-adjust:100%;}
    .shell{min-height:100vh;display:grid;place-items:center;padding:24px}
    .frame{width:min(1100px,96vw);background:var(--card);border-radius:20px;box-shadow:0 18px 60px rgba(15,23,42,.15);overflow:hidden;position:relative}
    .grid{display:grid;grid-template-columns:1fr}
    .card{padding:30px 28px 32px;display:grid;align-content:start;gap:18px}
    .card-wrap{width:min(500px,90vw);margin:18px auto;background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(15,23,42,.08);overflow:hidden}
    .welcome{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#fff;padding:18px 22px}
    .welcome small{display:block;opacity:.85;font-weight:600;letter-spacing:.2px}
    .welcome h2{margin:6px 0 0;font-size:28px}
    form{padding:20px 22px 22px}
    .row{display:grid;gap:12px}
    label{display:block;font-size:13px;font-weight:600;margin:6px 0 6px;color:#0f172a}
    input,select,canvas,textarea{width:100%;box-sizing:border-box;font-size:16px;padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff;color:var(--ink);min-height:44px;transition:border-color .2s,box-shadow .2s}
    input:focus,select:focus,textarea:focus,canvas:focus{border-color:var(--brand);box-shadow:0 0 0 3px color-mix(in oklab,var(--brand) 20%,transparent)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .note{font-size:12px;color:var(--muted);margin:-4px 0 8px}
    button[type="submit"]{width:100%;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#fff;border:none;padding:14px 18px;border-radius:999px;font-weight:700;font-size:16px;cursor:pointer;transition:all .2s;box-shadow:0 16px 30px rgba(26,71,135,.25);min-height:48px}
    button[type="submit"]:hover{filter:brightness(.95);transform:translateY(-1px)}
    button[type="submit"]:disabled{background:#cbd5e1;cursor:not-allowed;box-shadow:none}
    .hidden{display:none!important}
    
    /* Signature */
    .sig-wrap{position:relative;height:160px;border:1px dashed var(--border);border-radius:10px;overflow:clip;background:#f8fafc}
    #sig-canvas{width:100%;height:100%;display:block;cursor:crosshair}
    .sig-actions{position:absolute;right:10px;top:10px;display:flex;gap:8px}
    
    /* Buttons Ghost */
    .ghost{background:#f1f5f9;color:#475569;border:1px solid var(--border);padding:10px 14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s}
    .ghost:hover{background:#e2e8f0;border-color:#94a3b8}
    .ghost.danger{background:#fee2e2;color:#b91c1c;border-color:#fca5a5}

    /* Foto & Kamera & Cropper Styles */
    .photo-actions { display: flex; gap: 10px; margin-bottom: 8px; }
    .photo-actions button { flex: 1; }
    #foto-preview-container { position: relative; width: 150px; height: 150px; background: #f1f5f9; border-radius: 50%; overflow: hidden; margin: 0 auto 16px auto; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    #foto-preview-img { width: 100%; height: 100%; object-fit: cover; }
    #btn-hapus-foto { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 11px; border: none; padding: 6px; cursor: pointer; text-align: center; width: 100%; }

    /* Modal Umum (Camera & Cropper) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { width: 100%; max-width: 500px; background: #000; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-controls { display: flex; gap: 12px; width: 100%; padding: 16px; background: #1a1a1a; box-sizing: border-box; }
    
    /* Cropper Specific */
    #cropper-img { max-width: 100%; display: block; }
    .cropper-view-box, .cropper-face { border-radius: 50%; } /* Optional: Tampilan bulat visual saja */

    #msg{font-size:12px;margin-top:8px;text-align:center}
    #msg.success{color:#16a34a} #msg.error{color:#ef4444} #msg.loading{color:#2563eb}
    
    select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%2364748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-size:16px;background-position:right 12px center;background-repeat:no-repeat;padding-right:36px}
    
    @media (max-width:960px){.grid{grid-template-columns:1fr}.card{padding:12px}.card-wrap{width:100%;margin:8px 0 16px}.two{grid-template-columns:1fr}}
    .site-footer{background:#08324a;color:#fff;text-align:center;padding:16px 14px;font-weight:300;font-size:14px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="frame">
      <div class="grid">
        <section class="card">
          <div class="card-wrap">
            <div class="welcome">
              <small>Selamat Datang di History Club SMAN 32 Jakarta</small>
              <h2>Pendaftaran Anggota</h2>
            </div>

            <form id="form-daftar" novalidate>
              <div class="row">
                <label id="label-id" for="fd-nis">NIS / NISN / NIP *</label>
                <input id="fd-nis" placeholder="Masukkan Nomor Identitas" required />
              </div>

              <div class="row">
                <label for="fd-nama">Nama lengkap *</label>
                <input id="fd-nama" required autocomplete="name" autocapitalize="words" placeholder="Sesuai Dapodik/Absen" />
              </div>

              <div class="row">
                <label for="fd-tipe">Tipe keanggotaan *</label>
                <select id="fd-tipe" required>
                  <option value="siswa" selected>Siswa/Siswi Aktif SMAN 32</option>
                  <option value="guru">Guru/Tendik</option>
                  <option value="alumni">Alumni SMAN 32</option>
                  <option value="lain">Selain SMAN 32</option>
                </select>
              </div>

              <div id="group-siswa" class="row">
                <div class="two">
                  <div>
                    <label for="fd-kelas">Kelas *</label>
                    <select id="fd-kelas">
                        <option value="">Pilih Kelas...</option>
                    </select>
                  </div>
                  <div>
                    <label for="fd-angkatan">Angkatan *</label>
                    <select id="fd-angkatan">
                        <option value="">Pilih Tahun...</option>
                    </select>
                  </div>
                </div>
              </div>

              <div id="group-jabatan" class="row hidden">
                <label for="fd-jabatan">Jabatan (mis. Pembina, Pelatih, Guru PPL)</label>
                <input id="fd-jabatan" />
              </div>

              <div id="group-lulus" class="row hidden">
                <label for="fd-thn-lulus">Tahun Lulus</label>
                <input id="fd-thn-lulus" type="number" placeholder="Contoh: 2020" />
              </div>

              <div class="two">
                <div class="row">
                  <label for="fd-nohp">No HP (WhatsApp) *</label>
                  <input id="fd-nohp" type="tel" inputmode="numeric" required placeholder="08..." />
                </div>
                <div class="row">
                  <label for="fd-email">Email (opsional)</label>
                  <input id="fd-email" type="email" placeholder="email@google.com" />
                </div>
              </div>
              
              <div class="row">
                 <label for="fd-tgllahir">Tanggal Lahir (opsional)</label>
                 <input id="fd-tgllahir" type="date" />
              </div>

              <div class="row" style="margin-top: 10px; border-top: 1px dashed #e2e8f0; padding-top: 16px;">
                <label>Foto Profil (Wajib 1:1, Maks 1MB)</label>
                
                <div id="foto-preview-container">
                    <img id="foto-preview-img" src="" alt="Preview">
                    <button type="button" id="btn-hapus-foto">Hapus Foto</button>
                </div>
                
                <div class="photo-actions" id="photo-buttons">
                    <button type="button" class="ghost" id="btn-open-cam">üì∑ Kamera</button>
                    <button type="button" class="ghost" id="btn-open-file">üìÅ Pilih File</button>
                </div>
                <input type="file" id="inp-file-foto" accept="image/*" hidden>
                <input type="hidden" id="fd-foto-base64">
                <p class="note" style="text-align: center;">Foto akan otomatis di-crop menjadi persegi.</p>
              </div>

              <div class="row">
                <label for="sig-canvas">Tanda Tangan Digital *</label>
                <div class="sig-wrap">
                  <canvas id="sig-canvas"></canvas>
                  <div class="sig-actions">
                    <button class="ghost danger" type="button" id="sig-clear">Hapus</button>
                  </div>
                </div>
                <p class="note">Tanda tangan di dalam kotak di atas.</p>
              </div>

              <button type="submit" id="btn-submit">Kirim Pendaftaran</button>
              <p id="msg" aria-live="polite"></p>
            </form>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="cam-modal" class="modal-overlay">
      <div class="modal-content">
         <video id="cam-video" autoplay playsinline style="width:100%; background:black; min-height: 300px;"></video>
      </div>
      <div class="modal-controls">
          <button type="button" class="ghost danger" id="btn-cam-cancel" style="flex:1">Batal</button>
          <button type="button" class="ghost" id="btn-cam-capture" style="flex:2; background:white; color:black;">Ambil Foto</button>
      </div>
  </div>

  <div id="crop-modal" class="modal-overlay">
      <div class="modal-content" style="background: #333;">
          <div style="height: 400px; width: 100%;">
              <img id="cropper-img" src="" style="max-width: 100%;">
          </div>
      </div>
      <div class="modal-controls">
          <button type="button" class="ghost danger" id="btn-crop-cancel" style="flex:1">Batal</button>
          <button type="button" class="ghost" id="btn-crop-save" style="flex:2; background:white; color:black;">Simpan (Crop 1:1)</button>
      </div>
  </div>

  <footer class="site-footer">
    <p>¬© 2025 History Club SMAN 32 Jakarta.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
<script>
    // ==== 1. DROPDOWN KELAS & ANGKATAN ====
    // (Kode dropdown & kamera Anda sebelumnya SUDAH BENAR, biarkan saja)
    // ... (Copy-paste logika populateDropdowns, Camera, Cropper di sini) ...
    // ... (Atau biarkan kode lama Anda untuk bagian UI & Kamera, HANYA GANTI BAGIAN SUBMIT DI BAWAH INI) ...

    // ==== LOGIKA SUBMIT FORM (YANG PERLU DIGANTI) ====
    
    // Konfigurasi URL dihapus karena sudah ada di config.js
    // const WEB_APP_URL = "...";  <-- INI DIHAPUS SAJA

    // ... (Logika UI, Kamera, dan Cropper tetap sama seperti kode Anda sebelumnya) ...
    // ... (Pastikan kode populateDropdowns, camera logic, dll tetap ada di atas ini) ...

    // ==== 5. SUBMIT FORM (VERSI BARU) ====
    document.getElementById('form-daftar').addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = ''; msg.className = '';

      if(signaturePad.isEmpty()){ 
          msg.textContent = 'Tanda tangan wajib diisi.'; msg.className='error'; return; 
      }
      if(!hiddenBase64.value){
          msg.textContent = 'Foto profil wajib diisi.'; msg.className='error'; return;
      }

      const submitBtn = document.getElementById('btn-submit');
      submitBtn.disabled = true; submitBtn.textContent = 'Sedang Mengirim...';
      msg.textContent = 'Mohon tunggu, sedang mengupload data...'; msg.className='loading';

      try {
        const tipeUi = tipeSel.value;
        const tipe = mapUiTypeToBackend(tipeUi);
        const rawId = nisInput.value.trim();
        const d = onlyDigits(rawId);

        let payloadId = { nis:'', nisn:'', nip:'' };
        if(tipe === 'siswa-aktif') payloadId.nis = d;
        else if(tipe === 'guru') { payloadId.nip = d; payloadId.nis = d.slice(-7); }
        else if(tipe === 'alumni') payloadId.nis = d;
        else if(tipe === 'non-32') {
             if(d.length===18) { payloadId.nip = d; payloadId.nis = d.slice(-7); }
             else if(d.length===10) { payloadId.nisn = d; payloadId.nis = d.slice(-7); }
             else payloadId.nis = d;
        }

        const bodyData = {
          ...payloadId,
          nama: document.getElementById('fd-nama').value.trim(),
          tipe: tipe,
          kelas: (tipe === 'siswa-aktif') ? document.getElementById('fd-kelas').value : '',
          angkatan: (tipe === 'siswa-aktif') ? document.getElementById('fd-angkatan').value : '',
          nohp: document.getElementById('fd-nohp').value.trim(),
          email: document.getElementById('fd-email').value.trim(),
          fotoBase64: hiddenBase64.value,
          jabatan: (tipe!=='siswa-aktif' && tipe!=='alumni') ? document.getElementById('fd-jabatan').value.trim() : '',
          tahunLulus: (tipe==='alumni' || tipe==='guru') ? document.getElementById('fd-thn-lulus').value.trim() : '',
          tanggalLahir: document.getElementById('fd-tgllahir').value,
          tandaTangan: signaturePad.toDataURL('image/png')
        };

        // ‚ñº‚ñº‚ñº BAGIAN INI YANG BERUBAH (Memakai fungsi dari config.js) ‚ñº‚ñº‚ñº
        const out = await hc32_post('pendaftaran', bodyData);
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        if(out.status==='ok'){
          msg.textContent = 'Pendaftaran Berhasil! Terima kasih.'; msg.className='success';
          e.target.reset();
          signaturePad.clear();
          btnHapusFoto.click();
          applyTypeUI();
          setTimeout(() => { msg.textContent=''; }, 5000);
        } else if(out.status==='already'){
          msg.textContent = 'Nomor Identitas sudah terdaftar.'; msg.className='error';
        } else {
          msg.textContent = 'Gagal: ' + out.message; msg.className='error';
        }
      } catch(err){
        msg.textContent = 'Error Jaringan: ' + err.message; msg.className='error';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Kirim Pendaftaran';
      }
    });
</script>
</body>
</html>
