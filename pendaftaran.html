<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pendaftaran Anggota HC 32</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  
  <script src="config.js"></script>
  <script src="components.js"></script>
  
  <style>
    /* Styling Dasar */
    :root {
        --hc-blue: #1a4787; --hc-toska: #0f8a94; --hc-dark: #2e2e2e;
        --hc-green: #15a256; --hc-red: #d30e14; --hc-bg: #f8fafc;
        --hc-yellow: #ecec17; --border: #cbd5e1; --card: #ffffff;
    }

    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #2e2e2e; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
    .main-wrapper { flex: 1; padding: 40px 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    
    .card { background: #ffffff; border-radius: 16px; box-shadow: 0 8px 30px rgba(26, 71, 135, 0.08); padding: 30px; border: 1px solid #cbd5e1; }
    .welcome-banner { background: linear-gradient(135deg, var(--hc-blue) 0%, var(--hc-toska) 100%); color: #fff; padding: 24px; border-radius: 12px; margin-bottom: 28px; text-align: center; }
    .welcome-banner h2 { margin: 0 0 6px; font-size: 24px; font-weight: 700; }
    .welcome-banner p { margin: 0; opacity: 0.9; font-size: 14px; font-weight: 300; }

    /* Form Elements */
    .row { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #2e2e2e; }
    input, select { width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 15px; outline: none; background: #fff; box-sizing: border-box; transition: 0.2s; font-family: 'Poppins', sans-serif; }
    input:focus, select:focus { border-color: var(--hc-blue); box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.15); }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .hidden { display: none !important; }
    .note { font-size: 12px; color: #64748b; margin-top: 6px; }

    /* Buttons */
    button[type="submit"] { width: 100%; background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska)); color: #fff; border: none; padding: 16px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(15, 138, 148, 0.3); transition: 0.2s; }
    button[type="submit"]:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(15, 138, 148, 0.4); }
    button[type="submit"]:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; color: #64748b; }

    /* === UI FOTO UTAMA === */
    .photo-area { border: 2px dashed var(--hc-toska); border-radius: 16px; padding: 24px; text-align: center; background: #f0f9fa; position: relative; }
    #foto-preview-container { width: 150px; height: 150px; margin: 0 auto 16px; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: #e2e8f0; display: none; position: relative; }
    #foto-preview-img { width: 100%; height: 100%; object-fit: cover; }
    
    .btn-main-camera { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: white; border: 1px solid var(--hc-blue); color: var(--hc-blue); padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .btn-main-camera:hover { background: var(--hc-blue); color: white; }
    
    .btn-delete-photo { background: #fee2e2; color: #ef4444; border: none; margin-top: 10px; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: none; }

    /* === WINDOWED CAMERA MODAL === */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2500; display: none; align-items: center; justify-content: center; padding: 20px; }
    .cam-window-box { width: 100%; max-width: 600px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    .cam-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: 700; color: #2e2e2e; display: flex; align-items: center; gap: 8px; }
    .cam-view-wrapper { position: relative; width: 100%; height: 0; padding-bottom: 75%; background: #000; overflow: hidden; }
    #cam-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .cam-overlay-controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 10; }
    .btn-shutter { background: var(--hc-blue); color: white; border: 4px solid rgba(255,255,255,0.5); padding: 10px 24px; border-radius: 30px; font-weight: 600; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.1s; }
    .btn-shutter:active { transform: scale(0.95); }
    .btn-switch { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; display: none; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
    .cam-footer { padding: 15px; display: flex; gap: 10px; background: #fff; border-top: 1px solid #eee; }
    .btn-cam-action { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-red-action { background: #dc2626; color: white; }
    .btn-yellow-action { background: var(--hc-yellow); color: var(--hc-dark); transition: background 0.2s; }
    .btn-yellow-action:hover { background: #d4d40d; }

    /* Crop Modal */
    #crop-modal .modal-box { background: #1e293b; color: white; }
    .crop-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-modal.cancel { background: #334155; color: white; }
    .btn-modal.confirm { background: var(--hc-blue); color: white; }

    /* === SIGNATURE (WITH UNDO) === */
    .sig-wrapper { height: 180px; border: 1px solid #cbd5e1; border-radius: 10px; position: relative; background: #fff; overflow: hidden; }
    canvas#sig-canvas { width: 100%; height: 100%; display: block; }
    
    .sig-tools { position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 5px; }
    .sig-btn { 
        padding: 5px 10px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; 
        display: flex; align-items: center; gap: 4px;
    }
    .sig-btn-clear { background: #fee2e2; color: #ef4444; }
    .sig-btn-undo { background: #e0f2fe; color: #0284c7; }

    /* =========================================
       SECURITY CHECK STYLES (ENHANCED)
       ========================================= */
    .captcha-card {
        margin: 30px 0 20px;
        background: #fff; border-radius: 12px;
        border: 1px solid #cbd5e1; overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .captcha-header {
        background: linear-gradient(to right, #f8fafc, #fff);
        padding: 12px 20px; border-bottom: 1px solid #e2e8f0;
        font-weight: 700; color: var(--hc-dark); font-size: 14px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .captcha-body { padding: 20px; text-align: center; }
    
    /* 1. PUZZLE SLIDER (Background SUPERGRAPHIC) */
    .puzzle-area { 
        position: relative; width: 100%; height: 150px; 
        /* Ganti dengan URL gambar supergraphic Anda */
        background: url('SUPERGRAPHIC.png') center/cover; 
        border-radius: 8px; overflow: hidden; margin-bottom: 15px; 
    }
    .puzzle-hole { 
        width: 45px; height: 45px; 
        background: rgba(0,0,0,0.6); box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        position: absolute; top: 50px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3);
    }
    .puzzle-piece { 
        width: 45px; height: 45px; 
        /* Potongan puzzle juga mengambil background yang sama */
        background: url('SUPERGRAPHIC.png') center/cover;
        position: absolute; top: 50px; left: 10px; 
        border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white;
        cursor: grab;
    }
    .puzzle-slider { width: 100%; cursor: pointer; margin-top: 10px; }

    /* 2. ICON GRID (Improved) */
    .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .icon-btn {
        aspect-ratio: 1; border-radius: 8px; border: 2px solid #e2e8f0;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px; cursor: pointer; color: #64748b; background: #f8fafc;
        transition: all 0.2s; position: relative;
    }
    .icon-btn.selected { border-color: var(--hc-blue); background: #eff6ff; color: var(--hc-blue); }
    .icon-btn.selected::after {
        content: 'âœ“'; position: absolute; top: 4px; right: 4px;
        font-size: 10px; background: var(--hc-blue); color: white;
        width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
    }

    /* 3. TEXT CAPTCHA */
    .text-captcha-box {
        background: url('https://img.freepik.com/free-photo/abstract-paint-background_1048-6484.jpg'); 
        background-size: cover; padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative;
    }
    canvas#text-canvas { display: block; margin: 0 auto; border-radius: 6px; }
    .captcha-input-group { display: flex; gap: 8px; }
    .captcha-input { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; }
    .captcha-submit { background: #db2777; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

    /* 4 & 5. QUIZ (History/Flags) */
    .quiz-question { font-size: 16px; margin-bottom: 15px; color: #334155; }
    .flag-img { height: 80px; width: auto; display: block; margin: 10px auto; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .quiz-btn {
        padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
        background: #f8fafc; color: #334155; font-weight: 500; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
    }
    .quiz-btn:hover { background: #e2e8f0; }
    .quiz-btn.correct { background: var(--hc-green); color: white; border-color: var(--hc-green); }
    .quiz-btn.wrong { background: var(--hc-red); color: white; border-color: var(--hc-red); animation: shake 0.3s; }

    /* Verified Badge */
    .verified-state { 
        display: none; flex-direction: column; align-items: center; padding: 20px; color: var(--hc-green); 
    }
    .verified-icon { font-size: 40px; margin-bottom: 5px; }
    .verified-text { font-weight: 700; font-size: 16px; }

    @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }

    /* Status Modal Styles */
    .status-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000; display: none; align-items: center; justify-content: center; }
    .status-modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 320px; text-align: center; }
    .status-icon-circle { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .status-icon-circle.success { border: 4px solid var(--hc-green); }
    .status-icon-circle.error { border: 4px solid var(--hc-red); }
    .status-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--hc-blue); color: white; font-weight: 600; margin-top: 15px; cursor: pointer; }

    #hc32-loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .hc-loader { position: relative; width: 80px; height: 80px; margin-bottom: 15px; }
    .hc-loader-spinner { position: absolute; inset: 0; border-radius: 50%; border: 5px solid var(--hc-blue); border-top-color: var(--hc-toska); animation: hcspin 1s linear infinite; }
    .hc-loader-logo { width: 50px; height: 50px; position: absolute; top: 15px; left: 15px; border-radius: 50%; }
    @keyframes hcspin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
        .two-col { grid-template-columns: 1fr; }
        .card { padding: 20px; }
    }
  </style>
</head>
<body>

  <div id="hc32-loading-overlay">
      <div class="hc-loader">
          <div class="hc-loader-spinner"></div>
          <img src="https://lh3.googleusercontent.com/d/16VXxbcOF9h5zAzYEo2faAzmgqqhtHLlH" class="hc-loader-logo" alt="Logo HC">
      </div>
      <div class="hc-loader-text" id="loading-text">Memproses data...</div>
  </div>

  <div id="status-modal" class="status-modal-overlay" style="display: none;">
      <div class="status-modal-box">
          <div id="status-icon-container" class="status-icon-circle success"></div>
          <h3 id="status-title" style="margin: 0 0 10px;"></h3>
          <p id="status-desc" style="margin: 0; color:#666;"></p>
          <button id="status-btn" class="status-btn">Oke</button>
      </div>
  </div>

  <div class="main-wrapper">
      <div class="container">
          <div class="card">
              <div class="welcome-banner">
                  <h2>Formulir Pendaftaran</h2>
                  <p>Bergabunglah bersama kami untuk belajar dan berkembang.</p>
              </div>

              <form id="form-daftar" novalidate>
                  <div class="row">
                      <label>NIS / Identitas *</label>
                      <input id="fd-nis" placeholder="Nomor Induk Siswa" required />
                  </div>
                  <div class="row">
                      <label>Nama Lengkap *</label>
                      <input id="fd-nama" placeholder="Sesuai Absen" required />
                  </div>
                  <div class="row">
                      <label>Tipe Keanggotaan *</label>
                      <select id="fd-tipe">
                          <option value="siswa">Siswa Aktif SMAN 32</option>
                          <option value="guru">Guru/Tendik</option>
                          <option value="alumni">Alumni</option>
                          <option value="lain">Lainnya (Non-32)</option>
                      </select>
                  </div>

                  <div id="group-siswa" class="row">
                      <div class="two-col">
                          <div><label>Kelas *</label><select id="fd-kelas"><option value="">Pilih...</option></select></div>
                          <div><label>Angkatan *</label><select id="fd-angkatan"><option value="">Pilih...</option></select></div>
                      </div>
                  </div>
                  <div id="group-jabatan" class="row hidden"><label>Jabatan</label><input id="fd-jabatan"></div>
                  <div id="group-lulus" class="row hidden"><label>Tahun Lulus</label><input id="fd-thn-lulus" type="number"></div>

                  <div class="two-col row">
                      <div><label>No HP (WA) *</label><input id="fd-nohp" type="tel" required></div>
                      <div><label>Tanggal Lahir</label><input id="fd-tgllahir" type="date"></div>
                  </div>
                  <div class="row"><label>Email (Opsional)</label><input id="fd-email" type="email"></div>

                  <div class="row" style="margin-top:30px">
                      <label>Foto Profil (Wajib, 1:1)</label>
                      <div class="photo-area">
                          <div id="foto-preview-container">
                              <img id="foto-preview-img" src="" alt="Preview">
                          </div>
                          
                          <button type="button" class="btn-main-camera" id="btn-open-camera-ui">
                              <i class="ri-camera-fill"></i> Aktifkan Kamera
                          </button>
                          
                          <div style="display:flex; justify-content:center;">
                              <button type="button" class="btn-delete-photo" id="btn-hapus-foto">
                                  <i class="ri-delete-bin-line"></i> Hapus Foto
                              </button>
                          </div>

                          <input type="hidden" id="fd-foto-base64">
                      </div>
                  </div>

                  <div class="row">
                      <label>Tanda Tangan Digital *</label>
                      <div class="sig-wrapper">
                          <canvas id="sig-canvas"></canvas>
                          <div class="sig-tools">
                              <button type="button" class="sig-btn sig-btn-undo" id="sig-undo" title="Undo per garis">
                                  <i class="ri-arrow-go-back-line"></i> Undo
                              </button>
                              <button type="button" class="sig-btn sig-btn-clear" id="sig-clear" title="Hapus semua">
                                  <i class="ri-delete-bin-line"></i> Ulangi
                              </button>
                          </div>
                      </div>
                      <p class="note">Goreskan tanda tangan pada kotak di atas.</p>
                  </div>

                  <div class="captcha-card" id="captcha-area">
                      <div class="captcha-header">
                          <span><i class="ri-shield-check-fill"></i> Security Check</span>
                          <i class="ri-refresh-line" style="cursor:pointer;" id="captcha-reload" title="Ganti Metode"></i>
                      </div>
                      <div class="captcha-body">
                          
                          <div id="mode-puzzle" style="display:none;">
                              <p class="quiz-question">Geser slider agar potongan pas!</p>
                              <div class="puzzle-area">
                                  <div class="puzzle-hole" id="puzzle-target"></div>
                                  <div class="puzzle-piece" id="puzzle-piece"></div>
                              </div>
                              <input type="range" min="0" max="100" value="0" class="puzzle-slider" id="puzzle-input">
                          </div>

                          <div id="mode-grid" style="display:none;">
                              <p class="quiz-question" id="grid-instruction">Loading...</p>
                              <div class="icon-grid" id="grid-container"></div>
                              <button type="button" class="status-btn" style="margin-top:15px;" id="grid-verify">Verifikasi</button>
                          </div>

                          <div id="mode-text" style="display:none;">
                              <p class="quiz-question">Ketik kode di bawah ini:</p>
                              <div class="text-captcha-box">
                                  <canvas id="text-canvas" width="200" height="60"></canvas>
                              </div>
                              <div class="captcha-input-group">
                                  <input type="text" class="captcha-input" id="text-input" placeholder="Ketik kode...">
                                  <button type="button" class="captcha-submit" id="text-verify">Cek</button>
                              </div>
                          </div>

                          <div id="mode-quiz" style="display:none;">
                              <p class="quiz-question" id="quiz-question-text">Loading...</p>
                              <div id="flag-container"></div> <div class="quiz-options" id="quiz-options"></div>
                          </div>

                          <div id="verified-state" class="verified-state">
                              <i class="ri-checkbox-circle-fill verified-icon"></i>
                              <span class="verified-text">Terverifikasi</span>
                          </div>

                      </div>
                  </div>

                  <button type="submit" id="btn-submit" disabled>Kirim Data (Selesaikan Security Check)</button>
              </form>
          </div>
      </div>
  </div>

  <div id="cam-popup" class="modal-overlay">
      <div class="cam-window-box">
          <div class="cam-header">
              <i class="ri-camera-lens-line"></i> Ambil Foto
          </div>

          <div class="cam-view-wrapper">
              <video id="cam-video" autoplay playsinline muted></video>
              
              <div class="cam-overlay-controls">
                  <button class="btn-switch" id="btn-cam-switch" title="Ganti Kamera">
                      <i class="ri-camera-switch-line"></i>
                  </button>
                  <button class="btn-shutter" id="btn-cam-capture">Ambil Foto</button>
                  <div style="width:40px; display:none;" id="spacer-mobile"></div>
              </div>
          </div>

          <div class="cam-footer">
              <button class="btn-cam-action btn-red-action" id="btn-cam-cancel">
                  <i class="ri-close-circle-line"></i> Tutup Kamera
              </button>
              <button class="btn-cam-action btn-yellow-action" id="btn-cam-upload">
                  <i class="ri-folder-open-line"></i> Pilih File
              </button>
              <input type="file" id="inp-file-foto" accept="image/*" hidden>
          </div>
      </div>
  </div>

  <div id="crop-modal" class="modal-overlay">
      <div class="modal-box">
          <h3 style="margin:0 0 10px; text-align:center;">Sesuaikan Foto (1:1)</h3>
          <div style="height: 300px; width: 100%; background:#000;">
              <img id="cropper-img" src="" style="max-width: 100%; display:block;">
          </div>
          <div class="crop-actions">
              <button class="btn-modal cancel" id="btn-crop-cancel">Batal</button>
              <button class="btn-modal confirm" id="btn-crop-save">Simpan</button>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    // ==== INIT COMPONENTS ====
    document.addEventListener('DOMContentLoaded', () => initHC32Navigation('pendaftaran'));

    // ==== UI HELPERS ====
    const loader = document.getElementById("hc32-loading-overlay");
    const loadingText = document.getElementById("loading-text");
    const statusModal = document.getElementById('status-modal');
    const statusIconContainer = document.getElementById('status-icon-container');

    function showLoader(text) { loadingText.textContent = text; loader.style.display = 'flex'; }
    function hideLoader() { loader.style.display = 'none'; }
    
    function showStatus(type, title, msg) {
        statusModal.style.display = 'flex';
        document.getElementById('status-title').textContent = title;
        document.getElementById('status-desc').textContent = msg;
        statusIconContainer.className = 'status-icon-circle ' + type;
        statusIconContainer.innerHTML = type === 'success' ? 
            '<i class="ri-check-line" style="font-size:40px; color:var(--hc-green)"></i>' : 
            '<i class="ri-close-line" style="font-size:40px; color:var(--hc-red)"></i>';
    }
    document.getElementById('status-btn').onclick = () => statusModal.style.display = 'none';

    /* =========================================
       LOGIKA SECURITY CHECK (5 MODELS)
       ========================================= */
    let isVerified = false;
    let puzzleTarget = 0;
    let textCode = "";

    function resetCaptcha() {
        isVerified = false;
        document.getElementById('verified-state').style.display = 'none';
        
        // Disable Submit
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.textContent = 'Kirim Data (Selesaikan Security Check)';
        btn.style.background = '#cbd5e1';
        btn.style.color = '#64748b';
        btn.style.cursor = 'not-allowed';

        const modes = ['mode-puzzle', 'mode-grid', 'mode-text', 'mode-quiz'];
        const selected = modes[Math.floor(Math.random() * modes.length)];
        
        modes.forEach(m => document.getElementById(m).style.display = 'none');
        document.getElementById(selected).style.display = 'block';

        if (selected === 'mode-puzzle') initPuzzle();
        else if (selected === 'mode-grid') initGrid();
        else if (selected === 'mode-text') initTextCaptcha();
        else initQuiz();
    }

    function verifySuccess() {
        isVerified = true;
        ['mode-puzzle', 'mode-grid', 'mode-text', 'mode-quiz'].forEach(m => document.getElementById(m).style.display = 'none');
        document.getElementById('verified-state').style.display = 'flex';
        
        const btn = document.getElementById('btn-submit');
        btn.disabled = false;
        btn.textContent = 'Kirim Data';
        btn.style.background = 'linear-gradient(135deg, var(--hc-blue), var(--hc-toska))';
        btn.style.color = 'white';
        btn.style.cursor = 'pointer';
    }

    document.getElementById('captcha-reload').onclick = resetCaptcha;

    // --- 1. PUZZLE SLIDER LOGIC ---
    function initPuzzle() {
        const slider = document.getElementById('puzzle-input');
        const piece = document.getElementById('puzzle-piece');
        const target = document.getElementById('puzzle-target');
        
        // Random Target (10-70%)
        puzzleTarget = Math.floor(Math.random() * 60) + 10;
        target.style.left = puzzleTarget + '%';
        piece.style.left = '0%';
        
        // Posisi Background Piece (Agar pas dengan target)
        // Kita geser background position dari potongan agar cocok dengan lubang
        // Asumsi lebar area 100% ~ 300-500px. Simplifikasi visual:
        // Cukup geser posisi X dari potongan.
        
        slider.value = 0;

        slider.oninput = function() {
            piece.style.left = this.value + '%';
        };

        slider.onchange = function() {
            const diff = Math.abs(parseInt(this.value) - puzzleTarget);
            if (diff < 5) verifySuccess();
            else {
                alert("Posisi kurang pas, coba lagi!");
                slider.value = 0; piece.style.left = '0%';
            }
        };
    }

    // --- 2. ICON GRID LOGIC (Variasi Kategori) ---
    function initGrid() {
        const container = document.getElementById('grid-container');
        const instr = document.getElementById('grid-instruction');
        container.innerHTML = '';
        
        // Pool Ikon Lengkap
        const pool = {
            hewan: ['ri-bear-smile-line', 'ri-bird-line', 'ri-bug-line', 'ri-aliens-line', 'ri-mickey-line'],
            transport: ['ri-car-line', 'ri-bus-line', 'ri-bike-line', 'ri-rocket-line', 'ri-ship-line'],
            buah: ['ri-apple-line', 'ri-orange-line', 'ri-seedling-line', 'ri-leaf-line', 'ri-cactus-line']
        };

        const types = Object.keys(pool);
        const targetType = types[Math.floor(Math.random() * types.length)];
        const distractorType = types.find(t => t !== targetType);

        instr.textContent = `Pilih semua ikon ${targetType.toUpperCase()}`;

        // Ambil 3 Benar + 3 Salah
        const correctIcons = pool[targetType].slice(0, 3).map(i => ({ icon: i, type: targetType }));
        const wrongIcons = pool[distractorType].slice(0, 3).map(i => ({ icon: i, type: distractorType }));
        
        const gameIcons = [...correctIcons, ...wrongIcons].sort(() => Math.random() - 0.5);
        
        gameIcons.forEach(item => {
            const div = document.createElement('div');
            div.className = 'icon-btn';
            div.innerHTML = `<i class="${item.icon}"></i>`;
            div.dataset.type = item.type;
            div.onclick = function() { this.classList.toggle('selected'); };
            container.appendChild(div);
        });

        document.getElementById('grid-verify').onclick = () => {
            const selected = document.querySelectorAll('.icon-btn.selected');
            const allCorrect = Array.from(selected).every(el => el.dataset.type === targetType);
            const countCorrect = Array.from(selected).filter(el => el.dataset.type === targetType).length;
            
            if (selected.length > 0 && allCorrect && countCorrect >= 1) verifySuccess();
            else {
                alert("Jawaban salah! Perhatikan kategori.");
                document.querySelectorAll('.icon-btn').forEach(el => el.classList.remove('selected'));
            }
        };
    }

    // --- 3. TEXT CAPTCHA LOGIC ---
    function initTextCaptcha() {
        const canvas = document.getElementById('text-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,200,60);
        
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        textCode = "";
        for(let i=0; i<5; i++) textCode += chars.charAt(Math.floor(Math.random() * chars.length));
        
        ctx.font = "bold 30px Poppins";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.fillText(textCode, 100, 40);
        
        // Noise Lines
        for(let i=0; i<7; i++) {
            ctx.beginPath();
            ctx.moveTo(Math.random()*200, Math.random()*60);
            ctx.lineTo(Math.random()*200, Math.random()*60);
            ctx.strokeStyle = "rgba(255,255,255,0.7)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        document.getElementById('text-input').value = '';
        
        document.getElementById('text-verify').onclick = () => {
            if(document.getElementById('text-input').value.toUpperCase() === textCode) verifySuccess();
            else { alert("Kode salah!"); initTextCaptcha(); }
        };
    }

    // --- 4 & 5. QUIZ LOGIC (Flags via API) ---
    const quizData = [
        // Sejarah
        { type: 'text', q: "Tahun berapa Indonesia merdeka?", a: ["1945", "1998", "1928", "2020"], c: "1945" },
        { type: 'text', q: "Siapa proklamator Indonesia?", a: ["Soekarno-Hatta", "Suharto", "Jokowi", "Diponegoro"], c: "Soekarno-Hatta" },
        // Bendera (Code: 2 huruf ISO)
        { type: 'flag', code: 'id', name: 'Indonesia', options: ['Indonesia', 'Monaco', 'Polandia', 'Singapura'] },
        { type: 'flag', code: 'jp', name: 'Jepang', options: ['Jepang', 'Korea', 'China', 'Vietnam'] },
        { type: 'flag', code: 'gb', name: 'Inggris', options: ['Inggris', 'Amerika', 'Australia', 'Perancis'] },
        { type: 'flag', code: 'sa', name: 'Arab Saudi', options: ['Arab Saudi', 'Turki', 'Mesir', 'Iran'] },
        { type: 'flag', code: 'de', name: 'Jerman', options: ['Jerman', 'Belanda', 'Belgia', 'Rusia'] },
        { type: 'flag', code: 'br', name: 'Brazil', options: ['Brazil', 'Argentina', 'Portugal', 'Spanyol'] }
    ];

    function initQuiz() {
        const qData = quizData[Math.floor(Math.random() * quizData.length)];
        const qTextEl = document.getElementById('quiz-question-text');
        const flagCont = document.getElementById('flag-container');
        const optsEl = document.getElementById('quiz-options');
        
        flagCont.innerHTML = '';
        optsEl.innerHTML = '';

        let correct = '';
        let options = [];

        if (qData.type === 'flag') {
            qTextEl.textContent = "Bendera negara mana ini?";
            // Pakai FlagCDN (Lebih stabil dari Emoji)
            flagCont.innerHTML = `<img src="https://flagcdn.com/w160/${qData.code}.png" class="flag-img" alt="Flag">`;
            correct = qData.name;
            options = qData.options;
        } else {
            qTextEl.textContent = qData.q;
            correct = qData.c;
            options = qData.a;
        }

        const shuffledOptions = [...options].sort(() => Math.random() - 0.5);

        shuffledOptions.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'quiz-btn';
            btn.textContent = opt;
            btn.onclick = () => {
                if (opt === correct) {
                    btn.classList.add('correct');
                    setTimeout(verifySuccess, 500);
                } else {
                    btn.classList.add('wrong');
                    setTimeout(() => { btn.classList.remove('wrong'); initQuiz(); }, 500);
                }
            };
            optsEl.appendChild(btn);
        });
    }

    // ==== CAMERA LOGIC ====
    let stream = null;
    let currentFacingMode = 'user'; 
    let cropper = null;

    const camPopup = document.getElementById('cam-popup');
    const video = document.getElementById('cam-video');
    const cropModal = document.getElementById('crop-modal');
    const cropperImg = document.getElementById('cropper-img');
    
    const btnOpenCam = document.getElementById('btn-open-camera-ui');
    const btnDeletePhoto = document.getElementById('btn-hapus-foto');
    const previewContainer = document.getElementById('foto-preview-container');
    const previewImg = document.getElementById('foto-preview-img');
    const hiddenBase64 = document.getElementById('fd-foto-base64');

    btnOpenCam.addEventListener('click', () => openCameraStream());

    async function openCameraStream() {
        try {
            if(stream) stopCameraStream();
            const constraints = { video: { facingMode: currentFacingMode }, audio: false };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            camPopup.style.display = 'flex'; 
            
            const devices = await navigator.mediaDevices.enumerateDevices();
            const inputs = devices.filter(d => d.kind === 'videoinput');
            if(inputs.length > 1) {
                document.getElementById('btn-cam-switch').style.display = 'flex';
                document.getElementById('spacer-mobile').style.display = 'block';
            } else {
                document.getElementById('btn-cam-switch').style.display = 'none';
                document.getElementById('spacer-mobile').style.display = 'none';
            }
        } catch(e) {
            alert("Gagal membuka kamera: " + e.message);
        }
    }

    function stopCameraStream() {
        if(stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        camPopup.style.display = 'none';
    }

    document.getElementById('btn-cam-cancel').addEventListener('click', stopCameraStream);
    
    document.getElementById('btn-cam-switch').addEventListener('click', () => {
        currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
        video.style.transform = (currentFacingMode === 'user') ? 'scaleX(-1)' : 'scaleX(1)';
        openCameraStream();
    });

    document.getElementById('btn-cam-capture').addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        if(currentFacingMode === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0);
        stopCameraStream();
        startCropper(canvas.toDataURL('image/jpeg'));
    });

    document.getElementById('btn-cam-upload').addEventListener('click', () => {
        document.getElementById('inp-file-foto').click();
    });
    
    document.getElementById('inp-file-foto').addEventListener('change', (e) => {
        if(e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                stopCameraStream();
                startCropper(evt.target.result);
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function startCropper(imageSrc) {
        cropperImg.src = imageSrc;
        cropModal.style.display = 'flex';
        if(cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, { aspectRatio: 1, viewMode: 1 });
    }

    document.getElementById('btn-crop-cancel').addEventListener('click', () => {
        cropModal.style.display = 'none';
        if(cropper) cropper.destroy();
    });

    document.getElementById('btn-crop-save').addEventListener('click', () => {
        if(!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 600, height: 600, fillColor: '#fff' });
        canvas.toBlob((blob) => {
            const quality = (blob.size > 1000000) ? 0.6 : 0.9;
            const finalData = canvas.toDataURL('image/jpeg', quality);
            hiddenBase64.value = finalData;
            previewImg.src = finalData;
            previewContainer.style.display = 'block';
            btnOpenCam.innerHTML = '<i class="ri-camera-fill"></i> Ulangi Foto';
            btnDeletePhoto.style.display = 'block';
            cropModal.style.display = 'none';
            if(cropper) cropper.destroy();
        }, 'image/jpeg');
    });

    btnDeletePhoto.addEventListener('click', () => {
        hiddenBase64.value = '';
        previewImg.src = '';
        previewContainer.style.display = 'none';
        btnDeletePhoto.style.display = 'none';
        btnOpenCam.innerHTML = '<i class="ri-camera-fill"></i> Aktifkan Kamera';
        document.getElementById('inp-file-foto').value = '';
    });

    // ==== DATA FORM HELPERS ====
    const tipeSel = document.getElementById('fd-tipe');
    
    function populateDropdowns() {
        const kelasSelect = document.getElementById('fd-kelas');
        const tingkat = ['X', 'XI', 'XII'];
        tingkat.forEach(t => { for(let i=1; i<=8; i++) kelasSelect.add(new Option(`${t}-${i}`, `${t}-${i}`)); });
        const angkatanSelect = document.getElementById('fd-angkatan');
        [2026, 2027, 2028].forEach(yr => angkatanSelect.add(new Option(yr, yr)));
    }

    tipeSel.addEventListener('change', () => {
        const v = tipeSel.value;
        document.querySelectorAll('#group-siswa, #group-jabatan, #group-lulus').forEach(el => el.classList.add('hidden'));
        if (v === 'siswa') document.getElementById('group-siswa').classList.remove('hidden');
        else if (v === 'guru') {
            document.getElementById('group-jabatan').classList.remove('hidden');
            document.getElementById('group-lulus').classList.remove('hidden');
        } 
        else if (v === 'alumni') document.getElementById('group-lulus').classList.remove('hidden');
        else document.getElementById('group-jabatan').classList.remove('hidden');
    });

    // ==== SIGNATURE (WITH UNDO PER STROKE) ====
    const sigCanvas = document.getElementById('sig-canvas');
    let signaturePad = new SignaturePad(sigCanvas, { backgroundColor: 'rgba(255,255,255,0)' });
    
    function resizeSig() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        sigCanvas.width = sigCanvas.offsetWidth * ratio;
        sigCanvas.height = sigCanvas.offsetHeight * ratio;
        sigCanvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener('resize', resizeSig);
    
    document.getElementById('sig-clear').addEventListener('click', () => signaturePad.clear());
    
    // Fitur Undo (Menghapus goresan terakhir)
    document.getElementById('sig-undo').addEventListener('click', () => {
        const data = signaturePad.toData();
        if (data && data.length > 0) {
            data.pop(); // Hapus stroke terakhir
            signaturePad.fromData(data);
        }
    });

    // ==== SUBMIT ====
    document.addEventListener('DOMContentLoaded', () => {
        populateDropdowns();
        resizeSig();
        resetCaptcha(); // Start with random security check
    });

    document.getElementById('form-daftar').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isVerified) { alert("Harap selesaikan Security Check terlebih dahulu."); return; }
        if(signaturePad.isEmpty()) { showStatus('error', 'Tanda Tangan', 'Wajib diisi.'); return; }
        if(!hiddenBase64.value) { showStatus('error', 'Foto Profil', 'Wajib upload foto.'); return; }

        showLoader("Mengirim Data Pendaftaran...");
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;

        try {
            const rawId = document.getElementById('fd-nis').value.trim().replace(/\D+/g, '');
            const tipe = tipeSel.value === 'siswa' ? 'siswa-aktif' : tipeSel.value === 'lain' ? 'non-32' : tipeSel.value;
            
            let pl = { nis:'', nisn:'', nip:'' };
            if(tipe==='siswa-aktif') pl.nis = rawId;
            else if(tipe==='guru') { pl.nip = rawId; pl.nis = rawId.slice(-7); }
            else if(tipe==='alumni') pl.nis = rawId;
            else { 
                if(rawId.length===18) pl.nip=rawId; 
                else if(rawId.length===10) pl.nisn=rawId;
                else pl.nis = rawId;
                if(!pl.nis) pl.nis = rawId.slice(-7); 
            }

            const data = {
                ...pl,
                nama: document.getElementById('fd-nama').value.trim(),
                tipe: tipe,
                kelas: tipe === 'siswa-aktif' ? document.getElementById('fd-kelas').value : '',
                angkatan: tipe === 'siswa-aktif' ? document.getElementById('fd-angkatan').value : '',
                nohp: document.getElementById('fd-nohp').value.trim(),
                email: document.getElementById('fd-email').value.trim(),
                fotoBase64: hiddenBase64.value,
                jabatan: document.getElementById('fd-jabatan').value || '',
                tahunLulus: document.getElementById('fd-thn-lulus').value || '',
                tanggalLahir: document.getElementById('fd-tgllahir').value,
                tandaTangan: signaturePad.toDataURL('image/png')
            };

            const res = await hc32_post('pendaftaran', data);
            
            if(res.status === 'ok') {
                showStatus('success', 'Berhasil', 'Pendaftaran Anda diterima.');
                e.target.reset(); signaturePad.clear(); btnDeletePhoto.click();
                resetCaptcha(); // Reset for next submission
            } else if(res.status === 'already') {
                showStatus('error', 'Gagal', 'Nomor identitas sudah terdaftar.');
            } else {
                showStatus('error', 'Error', res.message);
            }
        } catch(err) {
            showStatus('error', 'Koneksi', err.message);
        } finally {
            hideLoader();
            btn.disabled = false;
        }
    });
  </script>
</body>
</html>
